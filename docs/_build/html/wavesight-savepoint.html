<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>#WaveSight &mdash; wavesight  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            wavesight
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="docs/wavesight.html">wavesight.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs/fields.html">fields.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs/maxwell.html">Maxwell’s Equations</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs/diffkernels.html">diffkernels.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs/misc.html">misc.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs/fieldgenesis.html">fieldgenesis.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs/fungenerators.html">fungenerators.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs/convstore.html">convstore.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="farfield.html"># Farfield Propagators</a></li>
<li class="toctree-l1"><a class="reference internal" href="multifiber.html"># Multifiber</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">wavesight</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">#WaveSight</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/wavesight-savepoint.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="#WaveSight">
<h1>#WaveSight<a class="headerlink" href="##WaveSight" title="Link to this heading">¶</a></h1>
<p><strong>wavesight</strong> is a package that solves several problems in computational electromagnetism. * It can solve for the guided modes in a step-index fiber. * It can approximate the refraction of fields across a planar interface with arbitrary index profile. * It can propagate fields using a free space propagator.</p>
<p>To show it at work, we shall do a thorough study of a multimode optical waveguide.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">codebase_dir</span> <span class="o">=</span> <span class="s1">&#39;/Users/juan/ZiaLab/Codebase&#39;</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">codebase_dir</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">wavesight</span> <span class="k">as</span> <span class="nn">ws</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">special</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">fsolve</span><span class="p">,</span> <span class="n">root_scalar</span>
<span class="kn">import</span> <span class="nn">cmasher</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.axes_divider</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format=&#39;retina&#39;
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning disabling RuntimeWarning often due to evalution of square roots with negative arguments.</span><span class="se">\n</span><span class="s2">Probably produced by scalar_root.&quot;</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Circle</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">ticker</span>
<span class="kn">import</span> <span class="nn">cmasher</span> <span class="k">as</span> <span class="nn">cmr</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Warning disabling RuntimeWarning often due to evalution of square roots with negative arguments.
Probably produced by scalar_root.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imports</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">from itertools import product</span>
<span class="s1">import numpy as np</span>
<span class="s1">import h5py</span>
<span class="s1">import fire</span>
<span class="s1">import os</span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="kn">from</span> <span class="nn">zizibee</span> <span class="kn">import</span> <span class="n">zizibee</span> <span class="k">as</span> <span class="n">zzb</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="n">exec</span><span class="p">(</span><span class="n">imports</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">fun1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This one and the next are just to emphasize the fact that</span>
<span class="sd">    that all the defined functions are packaged and uploaded.</span>
<span class="sd">    So that any functional dependenices of the target function</span>
<span class="sd">    are met.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">i</span> <span class="o">-</span> <span class="n">j</span> <span class="o">+</span> <span class="n">k</span> <span class="o">-</span> <span class="n">l</span>

<span class="k">def</span> <span class="nf">fun2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="n">l</span>

<span class="k">def</span> <span class="nf">input_params</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This is a function that maps the job index to the input parameters</span>
<span class="sd">    of the function to be run.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ranger</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">ranger</span><span class="p">,</span><span class="n">ranger</span><span class="p">,</span><span class="n">ranger</span><span class="p">,</span><span class="n">ranger</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">inputs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">complex_fun</span><span class="p">(</span><span class="n">job_index</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A silly function to debug things.</span>
<span class="sd">    The important thing is that the function is made so that the</span>
<span class="sd">    function value is saved to scratch_dir in h5 format.</span>
<span class="sd">    This function assumes that scratch_dir will be an available</span>
<span class="sd">    symbol when the function is run at CCV. This part is taken care of by run_at_ccv.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ins</span> <span class="o">=</span> <span class="n">input_params</span><span class="p">(</span><span class="n">job_index</span><span class="p">)</span>
    <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">=</span> <span class="n">ins</span>
    <span class="n">zrange</span> <span class="o">=</span> <span class="n">fun1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="n">fun2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zrange</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">.h5&#39;</span> <span class="o">%</span> <span class="n">job_index</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scratch_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ins</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">)</span>

<span class="n">job_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span><span class="s1">&#39;jlizaraz&#39;</span><span class="p">,</span>
              <span class="s1">&#39;numCores&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
              <span class="s1">&#39;numJobs&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span>
              <span class="s1">&#39;memInGB&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="s1">&#39;import_block&#39;</span><span class="p">:</span> <span class="n">imports</span><span class="p">,</span>
              <span class="s1">&#39;extra_py&#39;</span><span class="p">:</span> <span class="p">[],</span>
              <span class="s1">&#39;theglobals&#39;</span><span class="p">:</span> <span class="nb">globals</span><span class="p">(),</span>
              <span class="s1">&#39;fun_name&#39;</span><span class="p">:</span> <span class="s1">&#39;complex_fun&#39;</span><span class="p">,</span>
              <span class="s1">&#39;job_name&#39;</span><span class="p">:</span> <span class="s1">&#39;frodo&#39;</span><span class="p">}</span>
<span class="n">job_config</span> <span class="o">=</span> <span class="n">zzb</span><span class="o">.</span><span class="n">run_at_ccv</span><span class="p">(</span><span class="n">job_config</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># at this point the</span>
<span class="n">mac_folder</span><span class="p">,</span> <span class="n">ccv_folder</span> <span class="o">=</span> <span class="n">job_config</span><span class="p">[</span><span class="s1">&#39;scratch_dir_at_mac&#39;</span><span class="p">],</span> <span class="n">job_config</span><span class="p">[</span><span class="s1">&#39;scratch_dir_at_CCV&#39;</span><span class="p">]</span>
<span class="n">numJobs</span> <span class="o">=</span> <span class="n">job_config</span><span class="p">[</span><span class="s1">&#39;numJobs&#39;</span><span class="p">]</span>
<span class="n">ccv_fruit</span> <span class="o">=</span> <span class="n">zzb</span><span class="o">.</span><span class="n">get_ccv_values</span><span class="p">(</span><span class="n">mac_folder</span><span class="p">,</span> <span class="n">ccv_folder</span><span class="p">,</span> <span class="n">numJobs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The autoreload extension is already loaded. To reload it, use:
  %reload_ext autoreload
Establishing an SSH connection to CCV and launching a shell ...
Saving Python script to file ...
Uploading script to CCV ...
Composing the sbatch script ...
Writing sbatch script ...
Sending sbatch script ...
Mac folder does not exist, creating ...
Progress: |██████████████████████████████| 100.0% Complete Elapsed Time: 62.64s Remaining Time: -0.24s
</pre></div></div>
</div>
<section id="##FG050LGA">
<h2>##FG050LGA<a class="headerlink" href="###FG050LGA" title="Link to this heading">¶</a></h2>
<section id="###Calculate-the-allowed-propagation-constants-kz">
<h3>###Calculate the allowed propagation constants kz<a class="headerlink" href="####Calculate-the-allowed-propagation-constants-kz" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fiber_spec</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;NA&#39;</span><span class="p">:</span> <span class="mf">0.22</span><span class="p">,</span>
              <span class="s1">&#39;nCore&#39;</span><span class="p">:</span> <span class="mf">1.45</span><span class="p">,</span>
              <span class="s1">&#39;coreRadius&#39;</span><span class="p">:</span><span class="mf">25.</span><span class="p">,</span>
              <span class="s1">&#39;grid_divider&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="s1">&#39;nFree&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
              <span class="s1">&#39;free_space_wavelength&#39;</span><span class="p">:</span> <span class="mf">0.600</span><span class="p">}</span>
<span class="n">fiber_sol</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">multisolver</span><span class="p">(</span><span class="n">fiber_spec</span><span class="p">,</span> <span class="n">drawPlots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
========================================
Approx number of complex HE modes:  800
Approx number of TE modes:  28
Approx number of TM modes:  28
Approx number of total modes:  1658
Approx Max n for HE modes:  40
========================================
Calculting TE(0,n) propagation constants ...
Calculting TM(0,n) propagation constants ...
Calculting HE(m,n) propagation constants ...
m=53
========================================
HE modes = 1590
TE modes = 36
TM modes = 36
TOTAL modes = 1662
FROM_Vnum = 1658
========================================
</pre></div></div>
</div>
</section>
<section id="###Calculate-the-numerical-mode-basis">
<h3>###Calculate the numerical mode basis<a class="headerlink" href="####Calculate-the-numerical-mode-basis" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fiber_sol</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">calculate_numerical_basis</span><span class="p">(</span><span class="n">fiber_sol</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "5832a2d668fe445a96758e7061504fb0", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "0fa40185782b4bc5906977232209a7f1", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "eaf1a5cac1e9485e8c82e7dc6039b92d", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "25221056f16c46b198972e9a4dd3412e", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "08656bb4fb3244b1bcda0c99b236c9ea", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1e43b224bfd64d61a4c3cfd116ffa4ad", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "cb1dbf9076cb40a2be7cb277b08e863f", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "e0c5d5794f744c3abd0784dd2890b91c", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "918ec061052545be8b898623522e66bd", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "da3eb35258aa420f87802ecfc6049106", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a9c5e5e6b73c4c6b88b4714493757766", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "7d6208a219d24911a8e4a7ed830bdc01", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "968bc742026e42a5a3ebfa07822936c9", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9bc4fe03357e4bd9a6b6565d1eaab837", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f457e2f99408484a942feaf244459caa", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9f96f2f6dd84433496dfc1b44ef7bf5a", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ae4180541671476885cef0794096ff8c", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "55bd1ac7e7e04c11abd2e16689b7d06d", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1f035e628cdc4394ab5b90ee1c4b6056", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "269f63060dd944e98c3bd61ed334c03d", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d05c393d9f8a4c28bcf96f1ccb8035a9", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "eea8bcb8a4c4480c82c940ff8e1420da", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "5267f507e1ed418fbe46cc7a03100c4e", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d09bbdbd50b9446ba25b12685692ea05", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ca3a1eee3331403492a29fdc842ec5a5", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "e955ce2f6e594d36ba7e54039bce9f75", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "bc40dd81eea74924bd5a04a3094c1ac8", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "236e75b192924534a23bc64c540fa5a3", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9c4dfa799e004398b75d9401f2ccef73", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c553ebe777114364ad1270d68e9da2c8", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "57aeb58109474b19905594e57b02b386", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d789923fc09846c9a2a01369c7cf33e9", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d46427ec96ae42f892e21327da88b1ba", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c560097dfca54620a5bdac997dd5397e", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "92ab82a9e03443079d8c8a09130355db", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "6a1e4935decd458ba58dc47b4dfabf3c", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "b7d665e30f274343a740c20ef0850350", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "b0bdf7b267404252b1a476b8c0c8c0d8", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a6d9c8e574824583a54ea005e22cd649", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "34e3d14bb7e543ce878b8e3cf8b15447", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "feba27350cb94a8aacd0fadf03b465a4", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c9209ef89b6a4de28610797cdb968d1f", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "26985f55e62c4a1ab79e4050dbcf5a40", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9e0883b2467b4f25a2e3e22a46020b13", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "78f8d6cd417c47a4a6906c480d344abc", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "14e469e3a75148febe0803f0c19e04c2", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "08675dfa1ad54a6d94e327cc30e81996", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "7571e9d45dc34ca1b522a138d0163fd5", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "920d0c97423f49fabcd551c03e517064", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "30c7ed213f37450b9c2b2d23b788c9cd", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "7432bb834a774519b19f5b3408863d48", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c947a33fff814292bb357b735e6c6751", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "89ed1585121b4112814f2734b32cd53f", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "df079dadc4fe4b2ca85460cbbed345c8", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">fiber_sol</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;eigenbasis-FG050LGA.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fiber_sol = pickle.load(open(&#39;eigenbasis-FG050LGA.pkl&#39;, &#39;rb&#39;))</span>
<span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;coord_layout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">coordinate_layout</span><span class="p">(</span><span class="n">fiber_sol</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="###Plot-the-modes">
<h3>###Plot the modes<a class="headerlink" href="####Plot-the-modes" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.axes_divider</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Δs</span><span class="p">,</span> <span class="n">xrange</span><span class="p">,</span> <span class="n">yrange</span><span class="p">,</span> <span class="n">ρrange</span><span class="p">,</span> <span class="n">φrange</span><span class="p">,</span> <span class="n">Xg</span><span class="p">,</span> <span class="n">Yg</span><span class="p">,</span> <span class="n">ρg</span><span class="p">,</span> <span class="n">φg</span><span class="p">,</span> <span class="n">nxy</span><span class="p">,</span> <span class="n">crossMask</span><span class="p">,</span> <span class="n">numSamples</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;coord_layout&#39;</span><span class="p">]</span>
<span class="n">nCore</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;nCore&#39;</span><span class="p">]</span>
<span class="n">nCladding</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;nCladding&#39;</span><span class="p">]</span>
<span class="n">λfree</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;free_space_wavelength&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">annotations</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">modtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;TE&#39;</span><span class="p">,</span><span class="s1">&#39;TM&#39;</span><span class="p">,</span><span class="s1">&#39;HE&#39;</span><span class="p">]:</span>
    <span class="n">solkey</span> <span class="o">=</span> <span class="n">modtype</span> <span class="o">+</span> <span class="s1">&#39;kz&#39;</span>
    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">kzs</span> <span class="ow">in</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="n">solkey</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">kzidx</span><span class="p">,</span> <span class="n">kz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kzs</span><span class="p">):</span>
            <span class="n">γ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nCore</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">λfree</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">kz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">β</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">kz</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">nCladding</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">λfree</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">annotationTR</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">modtype</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">kzidx</span><span class="p">)</span>
            <span class="n">annotationBR</span> <span class="o">=</span> <span class="s1">&#39;kz=</span><span class="si">%.3f</span><span class="s1"> µm⁻¹&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kz</span><span class="p">)</span>
            <span class="n">annotations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">annotationTR</span><span class="p">,</span> <span class="n">annotationBR</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot one</span>
<span class="k">def</span> <span class="nf">fmt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;0&#39;</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.1e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;$</span><span class="si">{}</span><span class="s1"> E{{</span><span class="si">{}</span><span class="s1">}}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;dark_background&#39;</span><span class="p">)</span>
<span class="n">component_index</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Et_ρ&quot;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Et_ϕ&quot;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;Ht_ρ&quot;</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Ht_ϕ&quot;</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)}</span>
<span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
<span class="n">extent</span>  <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="o">-</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
<span class="k">for</span> <span class="n">fun_picker</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">]:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">fun_picker</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">]:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">watermelon</span>
        <span class="k">if</span> <span class="n">fun_picker</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">:</span>
            <span class="n">title_format</span> <span class="o">=</span> <span class="s1">&#39;Re{</span><span class="si">%s</span><span class="s1">}&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title_format</span> <span class="o">=</span> <span class="s1">&#39;Im{</span><span class="si">%s</span><span class="s1">}&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ember</span>
        <span class="n">title_format</span> <span class="o">=</span> <span class="s1">&#39;|</span><span class="si">%s</span><span class="s1">|&#39;</span>
    <span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">ci</span> <span class="ow">in</span> <span class="n">component_index</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">field</span>   <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;eigenbasis&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">,</span> <span class="n">ci</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ci</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">field</span>   <span class="o">=</span> <span class="n">fun_picker</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">fun_picker</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fun_picker</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">:</span>
                <span class="n">fun_picker</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span>
                <span class="n">title_format</span> <span class="o">=</span> <span class="s1">&#39;Im{</span><span class="si">%s</span><span class="s1">}&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fun_picker</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span>
                <span class="n">title_format</span> <span class="o">=</span> <span class="s1">&#39;Re{</span><span class="si">%s</span><span class="s1">}&#39;</span>
            <span class="n">field</span>   <span class="o">=</span> <span class="n">eigenbasis</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">ci</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ci</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">field</span>   <span class="o">=</span> <span class="n">fun_picker</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ci</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ci</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">fun_picker</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">]:</span>
            <span class="n">themax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">themax</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="o">-</span><span class="n">themax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">iplot</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">field</span><span class="p">,</span>
                <span class="c1"># vmin=vmin,</span>
                <span class="c1"># vmax=vmax,</span>
                <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmax</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span>
                <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x/µm&#39;</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y/µm&#39;</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_format</span> <span class="o">%</span> <span class="n">component</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">annotations</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axis</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">annotations</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axis</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
        <span class="n">circle</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">a</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
        <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">iplot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_15_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_15_0.png" style="width: 705px; height: 567px;" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_15_1.png" class="no-scaled-link" src="_images/wavesight-savepoint_15_1.png" style="width: 705px; height: 567px;" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot and export all</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;dark_background&#39;</span><span class="p">)</span>
<span class="n">component_index</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Et_ρ&quot;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Et_ϕ&quot;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;Ht_ρ&quot;</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Ht_ϕ&quot;</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)}</span>
<span class="n">extent</span>  <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="o">-</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">totalModes</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">fun_picker</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">]:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">fun_picker</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">]:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">watermelon</span>
            <span class="k">if</span> <span class="n">fun_picker</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">:</span>
                <span class="n">title_format</span> <span class="o">=</span> <span class="s1">&#39;Re{</span><span class="si">%s</span><span class="s1">}&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">title_format</span> <span class="o">=</span> <span class="s1">&#39;Im{</span><span class="si">%s</span><span class="s1">}&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ember</span>
            <span class="n">title_format</span> <span class="o">=</span> <span class="s1">&#39;|</span><span class="si">%s</span><span class="s1">|&#39;</span>
        <span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">ci</span> <span class="ow">in</span> <span class="n">component_index</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field</span>   <span class="o">=</span> <span class="n">eigenbasis</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">ci</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ci</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">field</span>   <span class="o">=</span> <span class="n">fun_picker</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">fun_picker</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fun_picker</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">:</span>
                    <span class="n">fun_picker</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span>
                    <span class="n">title_format</span> <span class="o">=</span> <span class="s1">&#39;Im{</span><span class="si">%s</span><span class="s1">}&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fun_picker</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span>
                    <span class="n">title_format</span> <span class="o">=</span> <span class="s1">&#39;Re{</span><span class="si">%s</span><span class="s1">}&#39;</span>
                <span class="n">field</span>   <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;eigenbasis&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">,</span> <span class="n">ci</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ci</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">field</span>   <span class="o">=</span> <span class="n">fun_picker</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ci</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ci</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">fun_picker</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">]:</span>
                <span class="n">themax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">themax</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="o">-</span><span class="n">themax</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">iplot</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">field</span><span class="p">,</span>
                    <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
                    <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                    <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x/µm&#39;</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y/µm&#39;</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_format</span> <span class="o">%</span> <span class="n">component</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">annotations</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axis</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">annotations</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axis</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
            <span class="n">circle</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">a</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
            <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
            <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">iplot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fun_picker</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">]:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;./FG050LGA/reim/mode-</span><span class="si">%d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;./FG050LGA/abs/mode-</span><span class="si">%d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">index</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="###Launching-fields-across-the-end-of-the-waveguide">
<h3>###Launching fields across the end of the waveguide<a class="headerlink" href="####Launching-fields-across-the-end-of-the-waveguide" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">totalModes</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;totalModes&#39;</span><span class="p">]</span>
<span class="n">λfree</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;free_space_wavelength&#39;</span><span class="p">]</span>
<span class="n">eigenbasis</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;eigenbasis&#39;</span><span class="p">]</span>
<span class="n">nCore</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;nCore&#39;</span><span class="p">]</span>
<span class="n">nCladding</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;nCladding&#39;</span><span class="p">]</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Δs</span><span class="p">,</span> <span class="n">xrange</span><span class="p">,</span> <span class="n">yrange</span><span class="p">,</span> <span class="n">ρrange</span><span class="p">,</span> <span class="n">φrange</span><span class="p">,</span> <span class="n">Xg</span><span class="p">,</span> <span class="n">Yg</span><span class="p">,</span> <span class="n">ρg</span><span class="p">,</span> <span class="n">φg</span><span class="p">,</span> <span class="n">nxy</span><span class="p">,</span> <span class="n">crossMask</span><span class="p">,</span> <span class="n">numSamples</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;coord_layout&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">annotations</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">modtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;TE&#39;</span><span class="p">,</span><span class="s1">&#39;TM&#39;</span><span class="p">,</span><span class="s1">&#39;HE&#39;</span><span class="p">]:</span>
    <span class="n">solkey</span> <span class="o">=</span> <span class="n">modtype</span> <span class="o">+</span> <span class="s1">&#39;kz&#39;</span>
    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">kzs</span> <span class="ow">in</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="n">solkey</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">kzidx</span><span class="p">,</span> <span class="n">kz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kzs</span><span class="p">):</span>
            <span class="n">γ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nCore</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">λfree</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">kz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">β</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">kz</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">nCladding</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">λfree</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">annotationTR</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">modtype</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">kzidx</span><span class="p">)</span>
            <span class="n">annotationBR</span> <span class="o">=</span> <span class="s1">&#39;kz=</span><span class="si">%.3f</span><span class="s1"> µm⁻¹&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kz</span><span class="p">)</span>
            <span class="n">annotations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">annotationTR</span><span class="p">,</span> <span class="n">annotationBR</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="n">indexPercent</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indexPercent</span> <span class="o">*</span> <span class="n">totalModes</span><span class="p">)</span>
<span class="n">nFree</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">annotations</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
<span class="c1"># pick the E and H fields</span>
<span class="n">Einc</span> <span class="o">=</span> <span class="n">eigenbasis</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
<span class="n">Hinc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">eigenbasis</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:])</span>
<span class="n">kref</span><span class="p">,</span> <span class="n">Eref</span><span class="p">,</span> <span class="n">Href</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">poyntingrefractor</span><span class="p">(</span><span class="n">Einc</span><span class="p">,</span> <span class="n">Hinc</span><span class="p">,</span> <span class="n">nFree</span><span class="p">,</span> <span class="n">nxy</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Calculating the Poynting vector field...
Calculating the magnitude of the Poynting field...
Calculating the transverse component of the Poynting field...
Calculating the unit vector in the direction of the Poynting vector...
Calculating the angle of incidence field...
Calculating the angle of refraction field...
Calculating the Fresnel coefficients...
Calculating the ζ of the local coord system...
Calculating the S and P component of the incident electric field...
Calculating the S and P component of the refracted electric field...
Calculating the total refracted electric field...
Calculating the refracted wavevector (normalized) field...
Calculating the refracted H field...
</pre></div></div>
</div>
</section>
<section id="###Convert-cylindrical-anchored-to-cartesian-into-cartesian-anchored-to-cartesian">
<h3>###Convert cylindrical anchored to cartesian into cartesian anchored to cartesian<a class="headerlink" href="####Convert-cylindrical-anchored-to-cartesian-into-cartesian-anchored-to-cartesian" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Δs</span><span class="p">,</span> <span class="n">xrange</span><span class="p">,</span> <span class="n">yrange</span><span class="p">,</span> <span class="n">ρrange</span><span class="p">,</span> <span class="n">φrange</span><span class="p">,</span> <span class="n">Xg</span><span class="p">,</span> <span class="n">Yg</span><span class="p">,</span> <span class="n">ρg</span><span class="p">,</span> <span class="n">φg</span><span class="p">,</span> <span class="n">nxy</span><span class="p">,</span> <span class="n">crossMask</span><span class="p">,</span> <span class="n">numSamples</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;coord_layout&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ccfield</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">from_cyl_cart_to_cart_cart</span><span class="p">(</span><span class="n">Einc</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">streamplot</span><span class="p">(</span><span class="n">Xg</span><span class="p">,</span> <span class="n">Yg</span><span class="p">,</span>
              <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">ccfield</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
              <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">ccfield</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x/µm&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y/µm&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_23_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_23_0.png" style="width: 540px; height: 525px;" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dummyfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ccfield</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">dummyfield</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">dummyfield</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">dummyfield</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ccfield</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">from_cyl_cart_to_cart_cart</span><span class="p">(</span><span class="n">dummyfield</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">streamplot</span><span class="p">(</span><span class="n">Xg</span><span class="p">,</span> <span class="n">Yg</span><span class="p">,</span>
              <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">ccfield</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
              <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">ccfield</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x/µm&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y/µm&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_24_0.png" src="_images/wavesight-savepoint_24_0.png" />
</div>
</div>
</section>
</section>
<section id="##Farfield-propagation-using-the-Rayleigh-Sommerfeld-integral">
<h2>##Farfield propagation using the Rayleigh-Sommerfeld integral<a class="headerlink" href="###Farfield-propagation-using-the-Rayleigh-Sommerfeld-integral" title="Link to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">doubleSlit</span><span class="p">(</span><span class="n">separation</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">apertureFun</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span>
                        <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">separation</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">separation</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
                         <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">apertureFun</span>

<span class="n">slitSep</span> <span class="o">=</span> <span class="mf">4.</span>
<span class="n">slitWidth</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">slitHeight</span> <span class="o">=</span> <span class="mf">10.</span>
<span class="n">Lobs</span> <span class="o">=</span> <span class="mf">100.</span>
<span class="n">z</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">nref</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">λfree</span> <span class="o">=</span> <span class="mf">0.532</span>
<span class="n">numSamples</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>

<span class="n">apFun</span> <span class="o">=</span> <span class="n">doubleSlit</span><span class="p">(</span><span class="n">slitSep</span><span class="p">,</span> <span class="n">slitWidth</span><span class="p">,</span> <span class="n">slitHeight</span><span class="p">)</span>

<span class="c1"># Estimate the diffraction pattern from the simplified formula</span>
<span class="n">diforders</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">xmaxi</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">diforder</span> <span class="ow">in</span> <span class="n">diforders</span><span class="p">:</span>
    <span class="n">stheta</span> <span class="o">=</span> <span class="n">diforder</span> <span class="o">*</span> <span class="n">λfree</span> <span class="o">/</span> <span class="n">slitSep</span>
    <span class="k">if</span> <span class="n">stheta</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">stheta</span><span class="p">)</span>
        <span class="n">xdif</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xdif</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">Lobs</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">xmaxi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xdif</span><span class="p">)</span>
            <span class="n">xmaxi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">xdif</span><span class="p">)</span>


<span class="n">numSamples</span><span class="p">,</span> <span class="n">xCoords</span><span class="p">,</span> <span class="n">yCoords</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">scalarfieldprop</span><span class="p">(</span><span class="n">Lobs</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">apFun</span><span class="p">,</span> <span class="n">λfree</span><span class="p">,</span> <span class="n">nref</span><span class="p">,</span> <span class="n">numSamples</span><span class="p">)</span>

<span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">xCoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xCoords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yCoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yCoords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">pField</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pField</span><span class="p">,</span>
        <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmr</span><span class="o">.</span><span class="n">ember</span><span class="p">,</span>
        <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;spline16&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xmaxi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xmaxi</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x/μm&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y/μm&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Diffraction pattern of a double slit</span><span class="se">\n</span><span class="s1">s=</span><span class="si">%.2f</span><span class="s1">μm | w=</span><span class="si">%.2f</span><span class="s1">μm | L=</span><span class="si">%.2f</span><span class="s1">μm | Δz=</span><span class="si">%.2f</span><span class="s1">μm&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slitWidth</span><span class="p">,</span> <span class="n">slitWidth</span><span class="p">,</span> <span class="n">slitHeight</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_26_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_26_0.png" style="width: 848px; height: 873px;" />
</div>
</div>
<section id="###Development-code">
<h3>###Development code<a class="headerlink" href="####Development-code" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[338]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># def circleAp(radius):</span>
<span class="c1">#     def apertureFun(x, y):</span>
<span class="c1">#         r2 = x**2 + y**2</span>
<span class="c1">#         return np.where(r2 &lt; radius**2, 1, 0)</span>
<span class="c1">#     return apertureFun</span>

<span class="c1"># apFun = circleAp(2.)</span>
<span class="c1"># apertureFunction = apFun</span>

<span class="c1"># def dot(width, xc, yc):</span>
<span class="c1">#     def apertureFun(x, y):</span>
<span class="c1">#         return np.where((np.abs(x - xc) &lt;= width/2) &amp; (np.abs(y + yc) &lt;= width/2), 1, 0)</span>
<span class="c1">#     return apertureFun</span>

<span class="c1"># apFun = dot(2, 0, 0)</span>
<span class="c1"># apertureFunction = apFun</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># def doubleSlit(separation, width, height):</span>
<span class="c1">#     def apertureFun(x, y):</span>
<span class="c1">#         return np.where((</span>
<span class="c1">#                         ((np.abs(x - separation/2) &lt;= width/2) | (np.abs(x + separation/2) &lt;= width/2))</span>
<span class="c1">#                          &amp; (np.abs(y) &lt;= height/2)</span>
<span class="c1">#         ), 1, 0)</span>
<span class="c1">#     return apertureFun</span>

<span class="c1"># slitSep = 4.</span>
<span class="c1"># slitWidth = 1.</span>
<span class="c1"># slitHeight = 10.</span>

<span class="c1"># apFun = doubleSlit(slitSep, slitWidth, slitHeight)</span>
<span class="c1"># apertureFunction = apFun</span>

<span class="c1"># Lobs = 100.</span>
<span class="c1"># z = 30.</span>
<span class="c1"># nref = 1</span>
<span class="c1"># λfree = 0.5</span>
<span class="c1"># numSamples = &#39;auto&#39;</span>
<span class="c1"># λ = λfree / nref</span>
<span class="c1"># k = 2*np.pi/λ</span>


<span class="c1"># # Estimate the diffraction pattern from the simplified formula</span>
<span class="c1"># diforders = range(10)</span>
<span class="c1"># xmaxi = []</span>
<span class="c1"># for diforder in diforders:</span>
<span class="c1">#     stheta = diforder * λfree / slitSep</span>
<span class="c1">#     if stheta &gt; 1:</span>
<span class="c1">#         break</span>
<span class="c1">#     else:</span>
<span class="c1">#         theta = np.arcsin(stheta)</span>
<span class="c1">#         xdif = z * np.tan(theta)</span>
<span class="c1">#         if np.abs(xdif) &lt;= Lobs/2:</span>
<span class="c1">#             xmaxi.append(xdif)</span>
<span class="c1">#             xmaxi.append(-xdif)</span>

<span class="c1"># def gr(r):</span>
<span class="c1">#     return (np.exp(1j * k * r) * z) * (1./r - 1j*k) / (2*np.pi * r**2)</span>

<span class="c1"># if numSamples == &#39;auto&#39;:</span>
<span class="c1">#     numSamples = round(2*Lobs/λ)</span>
<span class="c1"># else:</span>
<span class="c1">#     numSamples = numSamples</span>

<span class="c1"># apertureSamples = numSamples</span>
<span class="c1"># Lap = Lobs</span>
<span class="c1"># k = 2. * np.pi / λ</span>
<span class="c1"># Δζ = Lap / apertureSamples</span>
<span class="c1"># Δη = Δζ</span>

<span class="c1"># # ζ, η are coordinates in the source plane</span>
<span class="c1"># ζ = np.linspace(-Lap/2, Lap/2, apertureSamples)</span>
<span class="c1"># η = np.linspace(-Lap/2, Lap/2, apertureSamples)</span>
<span class="c1"># # x, y are coordinates in the observation plane</span>
<span class="c1"># x = np.linspace(-Lobs/2, Lobs/2, numSamples)</span>
<span class="c1"># y = np.linspace(-Lobs/2, Lobs/2, numSamples)</span>

<span class="c1"># ζmesh, ηmesh = np.meshgrid(ζ, η)</span>
<span class="c1"># xmesh, ymesh = np.meshgrid(x, y)</span>
<span class="c1"># padextra = (2*apertureSamples - 1) - numSamples</span>

<span class="c1"># # Put together the U array</span>
<span class="c1"># U = apertureFunction(ζmesh, ηmesh)</span>
<span class="c1"># U = np.pad(U,</span>
<span class="c1">#         pad_width=((0,padextra),(0,padextra)),</span>
<span class="c1">#         mode=&#39;constant&#39;,</span>
<span class="c1">#         constant_values=0.)</span>

<span class="c1"># # Put together the H array</span>
<span class="c1"># Hx1 = np.full((apertureSamples-1, 2*apertureSamples-1), x[0])</span>
<span class="c1"># Hx2 = np.tile(x, (2*apertureSamples-1,1)).T</span>
<span class="c1"># Hx  = np.concatenate((Hx1, Hx2))</span>
<span class="c1"># Hζ2 = np.full((apertureSamples-1, 2*apertureSamples-1), ζ[0])</span>
<span class="c1"># Hζ1 = np.tile(ζ[::-1], (2*apertureSamples - 1,1)).T</span>
<span class="c1"># Hζ  = np.concatenate((Hζ1, Hζ2)).T</span>
<span class="c1"># Hxζ = Hx - Hζ.T</span>

<span class="c1"># Hy1 = np.full((apertureSamples-1, 2*apertureSamples-1), y[0])</span>
<span class="c1"># Hy2 = np.tile(y, (2*apertureSamples-1,1)).T</span>
<span class="c1"># Hy  = np.concatenate((Hy1, Hy2))</span>
<span class="c1"># Hη2 = np.full((apertureSamples-1, 2*apertureSamples-1), η[0])</span>
<span class="c1"># Hη1 = np.tile(η[::-1], (2*apertureSamples - 1,1)).T</span>
<span class="c1"># Hη  = np.concatenate((Hη1, Hη2)).T</span>
<span class="c1"># Hyη = Hy - Hη.T</span>
<span class="c1"># Hyη = Hyη.T</span>

<span class="c1"># # calculate r</span>

<span class="c1"># rEva = np.sqrt(Hxζ**2 + Hyη**2 + z**2)</span>
<span class="c1"># H = gr(rEva)</span>

<span class="c1"># FFU = fft2(U)</span>
<span class="c1"># FFH = fft2(H)</span>
<span class="c1"># FFUH = FFU * FFH</span>
<span class="c1"># S = ifft2(FFUH)</span>

<span class="c1"># # get the good parts</span>
<span class="c1"># field = (Δη*Δζ) * S[-apertureSamples::,-apertureSamples::]</span>

<span class="c1"># extent = (x[0], x[-1], y[0], y[-1])</span>
<span class="c1"># pField = np.abs(field)</span>
<span class="c1"># fig, ax = plt.subplots(figsize=(10,10))</span>
<span class="c1"># ax.imshow(pField,</span>
<span class="c1">#         extent=extent,</span>
<span class="c1">#         cmap=cmr.ember,</span>
<span class="c1">#         interpolation=&#39;spline16&#39;)</span>
<span class="c1"># ax.scatter(xmaxi, np.zeros_like(xmaxi), s=20, facecolors=&#39;none&#39;, edgecolors=&#39;w&#39;, alpha=0.5)</span>
<span class="c1"># ax.set_xlabel(&#39;x/μm&#39;)</span>
<span class="c1"># ax.set_ylabel(&#39;y/μm&#39;)</span>
<span class="c1"># ax.set_title(&#39;Diffraction pattern of a double slit\ns=%.2fμm | w=%.2fμm | L=%.2fμm&#39; % (slitWidth, slitWidth, slitHeight))</span>
<span class="c1"># plt.show()</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># def scalarfieldprop(Lobs, z, apertureFunction, λfree, nref, numSamples=&#39;auto&#39;):</span>
<span class="c1">#     &#39;&#39;&#39;</span>
<span class="c1">#     scalarfieldprop  takes  a  field  component in an aperture plane and</span>
<span class="c1">#     propagates  that  to an observation plane by using an implementation</span>
<span class="c1">#     of  the  direct  integration  of the Rayleigh-Sommerfeld diffraction</span>
<span class="c1">#     integral.  This  implementation  is based on the method described in</span>
<span class="c1">#     Shen and Wang (2006). The field is sampled in the aperture plane and</span>
<span class="c1">#     in  the obserbation plane using a uniform grid. The field is assumed</span>
<span class="c1">#     to be zero outside of the aperture plane.</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     +  Lobs  (float): spatial width of the obsevation region, in μm. The</span>
<span class="c1">#     observation  region  is  assumed to be a squared centered on (x,y) =</span>
<span class="c1">#     (0,0),  and  extending  from  -Lobs/2  to Lobs/2 in both the x and y</span>
<span class="c1">#     directions.</span>

<span class="c1">#     + z (float): distance between the aperture plane and the observation</span>
<span class="c1">#     plane, given in μm. The aperture plane is assumed to be at z=0.</span>

<span class="c1">#     +  apertureFunction  (function):  a bi-variate function that returns</span>
<span class="c1">#     the  complex  amplitude of the field in the aperture plane. Input to</span>
<span class="c1">#     the function is assumed to be in cartesian coordinates x,y.  If  the</span>
<span class="c1">#     function has an attribute &quot;null&quot; set to True, then the function will</span>
<span class="c1">#     simply return a matrix of zeros.</span>

<span class="c1">#     + λfree (float): wavelength in vaccum of field, given in μm.</span>

<span class="c1">#     + nref (float): refractive index of the propagating medium.</span>

<span class="c1">#     Options</span>
<span class="c1">#     -------</span>
<span class="c1">#     +  &quot;numSamples&quot;  (int or Automatic): number of samples to use in the</span>
<span class="c1">#     aperture  plane  and  the  observation  plane. The aperture plane is</span>
<span class="c1">#     sampled  using  a  uniform  grid,  and the observation plane is also</span>
<span class="c1">#     sampled using a uniform grid. The default is Automatic in which case</span>
<span class="c1">#     numSamples  is  calculated  so that the sample size is equal to half</span>
<span class="c1">#     the wavelength of the wave inside of the propagating medium.</span>

<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     (numSamples, xCoords, yCoords, field) (tuple)</span>
<span class="c1">#     +  xCoords (np.array): x coordinates of the observation plane, given</span>
<span class="c1">#     in μm.</span>

<span class="c1">#     +  yCoords (np.array): y coordinates of the observation plane, given</span>
<span class="c1">#     in μm.</span>

<span class="c1">#     +   field   (np.array):  complex  amplitude  of  the  field  in  the</span>
<span class="c1">#     observation  plane.  The top left corner of the array corresponds to</span>
<span class="c1">#     the  lower  left  corner  of  the observation plane. The coordinates</span>
<span class="c1">#     associated with each element in the given array should be taken from</span>
<span class="c1">#     xCoords and yCoords.</span>

<span class="c1">#     References</span>
<span class="c1">#     ----------</span>
<span class="c1">#     +   Shen,   Fabin,  and  Anbo  Wang.  &quot;Fast-Fourier-transform  based</span>
<span class="c1">#     numerical integration method for the Rayleigh-Sommerfeld diffraction</span>
<span class="c1">#     formula.&quot; Applied optics 45, no. 6 (2006): 1102-1110.</span>

<span class="c1">#     Example (double slit):</span>
<span class="c1">#     ----------------------</span>

<span class="c1">#     def doubleSlit(separation, width, height):</span>
<span class="c1">#         def apertureFun(x, y):</span>
<span class="c1">#             return np.where((</span>
<span class="c1">#                             ((np.abs(x - separation/2) &lt;= width/2) | (np.abs(x + separation/2) &lt;= width/2))</span>
<span class="c1">#                             &amp; (np.abs(y) &lt;= height/2)</span>
<span class="c1">#             ), 1, 0)</span>
<span class="c1">#         return apertureFun</span>

<span class="c1">#     slitSep = 4.</span>
<span class="c1">#     slitWidth = 1.</span>
<span class="c1">#     slitHeight = 10.</span>
<span class="c1">#     Lobs = 100.</span>
<span class="c1">#     z = 100</span>
<span class="c1">#     nref = 1</span>
<span class="c1">#     λfree = 0.532</span>
<span class="c1">#     numSamples = &#39;auto&#39;</span>

<span class="c1">#     apFun = doubleSlit(slitSep, slitWidth, slitHeight)</span>

<span class="c1">#     # Estimate the diffraction pattern from the simplified formula</span>
<span class="c1">#     diforders = range(10)</span>
<span class="c1">#     xmaxi = []</span>
<span class="c1">#     for diforder in diforders:</span>
<span class="c1">#         stheta = diforder * λfree / slitSep</span>
<span class="c1">#         if stheta &gt; 1:</span>
<span class="c1">#             break</span>
<span class="c1">#         else:</span>
<span class="c1">#             theta = np.arcsin(stheta)</span>
<span class="c1">#             xdif = z * np.tan(theta)</span>
<span class="c1">#             if np.abs(xdif) &lt;= Lobs/2:</span>
<span class="c1">#                 xmaxi.append(xdif)</span>
<span class="c1">#                 xmaxi.append(-xdif)</span>


<span class="c1">#     numSamples, xCoords, yCoords, field = scalarfieldprop(Lobs, z, apFun, λfree, nref, numSamples)</span>

<span class="c1">#     extent = (xCoords[0], xCoords[-1], yCoords[0], yCoords[-1])</span>
<span class="c1">#     pField = np.abs(field)</span>
<span class="c1">#     fig, ax = plt.subplots(figsize=(10,10))</span>
<span class="c1">#     ax.imshow(pField,</span>
<span class="c1">#             extent=extent,</span>
<span class="c1">#             cmap=cmr.ember,</span>
<span class="c1">#             interpolation=&#39;spline16&#39;)</span>
<span class="c1">#     ax.scatter(xmaxi, np.zeros_like(xmaxi), s=20, facecolors=&#39;none&#39;, edgecolors=&#39;w&#39;, alpha=0.5)</span>
<span class="c1">#     ax.set_xlabel(&#39;x/μm&#39;)</span>
<span class="c1">#     ax.set_ylabel(&#39;y/μm&#39;)</span>
<span class="c1">#     ax.set_title(&#39;Diffraction pattern of a double slit\ns=%.2fμm | w=%.2fμm | L=%.2fμm | Δz=%.2fμm&#39; % (slitWidth, slitWidth, slitHeight, z))</span>
<span class="c1">#     plt.show()</span>

<span class="c1">#     &#39;&#39;&#39;</span>
<span class="c1">#     assert z&gt;=0, &#39;z must be positive&#39;</span>

<span class="c1">#     λ = λfree / nref</span>
<span class="c1">#     k = 2*np.pi/λ</span>

<span class="c1">#     def gr(r):</span>
<span class="c1">#         return (np.exp(1j * k * r) * z) * (1./r - 1j*k) / (2*np.pi * r**2)</span>

<span class="c1">#     if numSamples == &#39;auto&#39;:</span>
<span class="c1">#         numSamples = round(2*Lobs/λ)</span>
<span class="c1">#     else:</span>
<span class="c1">#         numSamples = numSamples</span>

<span class="c1">#     apertureSamples = numSamples</span>
<span class="c1">#     Lap = Lobs</span>
<span class="c1">#     k = 2. * np.pi / λ</span>
<span class="c1">#     Δζ = Lap / apertureSamples</span>
<span class="c1">#     Δη = Δζ</span>

<span class="c1">#     # ζ, η are coordinates in the source plane</span>
<span class="c1">#     ζCoords = np.linspace(-Lap/2, Lap/2, apertureSamples)</span>
<span class="c1">#     ηCoords = np.linspace(-Lap/2, Lap/2, apertureSamples)</span>
<span class="c1">#     # x, y are coordinates in the observation plane</span>
<span class="c1">#     xCoords = np.linspace(-Lobs/2, Lobs/2, numSamples)</span>
<span class="c1">#     yCoords = np.linspace(-Lobs/2, Lobs/2, numSamples)</span>

<span class="c1">#     # An override to help the cases in vector field propagation</span>
<span class="c1">#     # where some field component is identically zero</span>

<span class="c1">#     if hasattr(apertureFunction, &#39;null&#39;):</span>
<span class="c1">#         if apertureFunction.null:</span>
<span class="c1">#             return (numSamples, xCoords, yCoords, np.zeros((numSamples, numSamples)))</span>

<span class="c1">#     ζmesh, ηmesh = np.meshgrid(ζCoords, ηCoords)</span>
<span class="c1">#     padextra = (2*apertureSamples - 1) - numSamples</span>

<span class="c1">#     # Put together the U array</span>
<span class="c1">#     U = apertureFunction(ζmesh, ηmesh)</span>

<span class="c1">#     # if z=0 there&#39;s nothing to do and the same input field should be returned</span>
<span class="c1">#     if z == 0:</span>
<span class="c1">#         return (numSamples, xCoords, yCoords, U)</span>

<span class="c1">#     U = np.pad(U,</span>
<span class="c1">#             pad_width=((0,padextra),(0,padextra)),</span>
<span class="c1">#             mode=&#39;constant&#39;,</span>
<span class="c1">#             constant_values=0.)</span>

<span class="c1">#     x0 = xCoords[0]</span>
<span class="c1">#     y0 = yCoords[0]</span>
<span class="c1">#     η0 = ηCoords[0]</span>
<span class="c1">#     ζ0 = ζCoords[0]</span>
<span class="c1">#     # Put together the H array</span>
<span class="c1">#     Hx1 = np.full((apertureSamples-1, 2*apertureSamples-1), x0)</span>
<span class="c1">#     Hx2 = np.tile(xCoords, (2*apertureSamples-1,1)).T</span>
<span class="c1">#     Hx  = np.concatenate((Hx1, Hx2))</span>

<span class="c1">#     Hζ2 = np.full((apertureSamples-1, 2*apertureSamples-1), ζ0)</span>
<span class="c1">#     Hζ1 = np.tile(ζCoords[::-1], (2*apertureSamples - 1,1)).T</span>
<span class="c1">#     Hζ  = np.concatenate((Hζ1, Hζ2)).T</span>

<span class="c1">#     Hxζ = Hx - Hζ.T</span>

<span class="c1">#     Hy1 = np.full((apertureSamples-1, 2*apertureSamples-1), y0)</span>
<span class="c1">#     Hy2 = np.tile(yCoords, (2*apertureSamples-1,1)).T</span>
<span class="c1">#     Hy  = np.concatenate((Hy1, Hy2))</span>

<span class="c1">#     Hη2 = np.full((apertureSamples-1, 2*apertureSamples-1), η0)</span>
<span class="c1">#     Hη1 = np.tile(ηCoords[::-1], (2*apertureSamples - 1,1)).T</span>
<span class="c1">#     Hη  = np.concatenate((Hη1, Hη2)).T</span>

<span class="c1">#     Hyη = (Hy - Hη.T).T</span>

<span class="c1">#     # calculate r</span>
<span class="c1">#     rEva = np.sqrt(Hxζ**2 + Hyη**2 + z**2)</span>
<span class="c1">#     # evaluate gr</span>
<span class="c1">#     H = gr(rEva)</span>

<span class="c1">#     # compute the Fourier transforms</span>
<span class="c1">#     FFU = fft2(U)</span>
<span class="c1">#     FFH = fft2(H)</span>
<span class="c1">#     # perform the convolution</span>
<span class="c1">#     FFUH = FFU * FFH</span>
<span class="c1">#     # invert the result</span>
<span class="c1">#     S = ifft2(FFUH)</span>
<span class="c1">#     # get the good parts</span>
<span class="c1">#     field = (Δη*Δζ) * S[-apertureSamples::,-apertureSamples::]</span>

<span class="c1">#     return (numSamples, xCoords, yCoords, field)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">doubleSlit</span><span class="p">(</span><span class="n">separation</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">apertureFun</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span>
                        <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">separation</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">separation</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
                         <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">apertureFun</span>

<span class="n">slitSep</span> <span class="o">=</span> <span class="mf">4.</span>
<span class="n">slitWidth</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">slitHeight</span> <span class="o">=</span> <span class="mf">10.</span>
<span class="n">Lobs</span> <span class="o">=</span> <span class="mf">100.</span>
<span class="n">z</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">nref</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">λfree</span> <span class="o">=</span> <span class="mf">0.532</span>
<span class="n">numSamples</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>

<span class="n">apFun</span> <span class="o">=</span> <span class="n">doubleSlit</span><span class="p">(</span><span class="n">slitSep</span><span class="p">,</span> <span class="n">slitWidth</span><span class="p">,</span> <span class="n">slitHeight</span><span class="p">)</span>

<span class="c1"># Estimate the diffraction pattern from the simplified formula</span>
<span class="n">diforders</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">xmaxi</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">diforder</span> <span class="ow">in</span> <span class="n">diforders</span><span class="p">:</span>
    <span class="n">stheta</span> <span class="o">=</span> <span class="n">diforder</span> <span class="o">*</span> <span class="n">λfree</span> <span class="o">/</span> <span class="n">slitSep</span>
    <span class="k">if</span> <span class="n">stheta</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">stheta</span><span class="p">)</span>
        <span class="n">xdif</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xdif</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">Lobs</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">xmaxi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xdif</span><span class="p">)</span>
            <span class="n">xmaxi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">xdif</span><span class="p">)</span>


<span class="n">numSamples</span><span class="p">,</span> <span class="n">xCoords</span><span class="p">,</span> <span class="n">yCoords</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">scalarfieldprop</span><span class="p">(</span><span class="n">Lobs</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">apFun</span><span class="p">,</span> <span class="n">λfree</span><span class="p">,</span> <span class="n">nref</span><span class="p">,</span> <span class="n">numSamples</span><span class="p">)</span>

<span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">xCoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xCoords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yCoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yCoords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">pField</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pField</span><span class="p">,</span>
        <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmr</span><span class="o">.</span><span class="n">ember</span><span class="p">,</span>
        <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;spline16&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xmaxi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xmaxi</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x/μm&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y/μm&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Diffraction pattern of a double slit</span><span class="se">\n</span><span class="s1">s=</span><span class="si">%.2f</span><span class="s1">μm | w=</span><span class="si">%.2f</span><span class="s1">μm | L=</span><span class="si">%.2f</span><span class="s1">μm | Δz=</span><span class="si">%.2f</span><span class="s1">μm&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slitWidth</span><span class="p">,</span> <span class="n">slitWidth</span><span class="p">,</span> <span class="n">slitHeight</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_31_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_31_0.png" style="width: 599px; height: 617px;" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># def vectorfieldprop(Lobs, z, apertureFunctions, λfree, nref, numSamples=&#39;auto&#39;):</span>
<span class="c1">#     &#39;&#39;&#39;</span>
<span class="c1">#     vectorfieldprop  takes a field with three cartesian components in an</span>
<span class="c1">#     aperture  plane and propagates that to an observation plane by using</span>
<span class="c1">#     an  implementation  of  the  direct  integration  of  the  Rayleigh-</span>
<span class="c1">#     Sommerfeld diffraction integral. This implementation is based on the</span>
<span class="c1">#     method  described  in  Shen and Wang (2006). The field is sampled in</span>
<span class="c1">#     the  aperture  plane  and  in  the obserbation plane using a uniform</span>
<span class="c1">#     grid. The field is assumed to be zero outside of the aperture plane.</span>
<span class="c1">#     No  checks  are  made  that  the given field components constitute a</span>
<span class="c1">#     valid electromagnetic field. It assumes that the refractive index is</span>
<span class="c1">#     isotropic.</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     +  Lobs  (float): spatial width of the obsevation region, in μm. The</span>
<span class="c1">#     observation  region  is  assumed to be a squared centered on (x,y) =</span>
<span class="c1">#     (0,0),  and  extending  from  -Lobs/2  to Lobs/2 in both the x and y</span>
<span class="c1">#     directions.</span>

<span class="c1">#     + z (float): distance between the aperture plane and the observation</span>
<span class="c1">#     plane, given in μm. The aperture plane is assumed to be at z=0.</span>

<span class="c1">#     + apertureFunctions (tuple): a tuple with three bi-variate functions</span>
<span class="c1">#     which  return  the  complex  amplitude  of  the  corresponding field</span>
<span class="c1">#     cartesian component in the aperture plane. Input to the functions is</span>
<span class="c1">#     assumed  to  be in cartesian coordinates x,y. If the function has an</span>
<span class="c1">#     attribute &quot;null&quot; set to True, then the function will simply return a</span>
<span class="c1">#     matrix of zeros.</span>

<span class="c1">#     + λfree (float): wavelength in vaccum of field, given in μm.</span>

<span class="c1">#     + nref (float): refractive index of the propagating medium.</span>

<span class="c1">#     Options</span>
<span class="c1">#     -------</span>
<span class="c1">#     +  &quot;numSamples&quot;  (int or Automatic): number of samples to use in the</span>
<span class="c1">#     aperture  plane  and  the  observation  plane. The aperture plane is</span>
<span class="c1">#     sampled  using  a  uniform  grid,  and the observation plane is also</span>
<span class="c1">#     sampled using a uniform grid. The default is Automatic in which case</span>
<span class="c1">#     numSamples  is  calculated  so that the sample size is equal to half</span>
<span class="c1">#     the wavelength of the wave inside of the propagating medium.</span>

<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     (numSamples, xCoords, yCoords, field) (tuple)</span>
<span class="c1">#     +  xCoords (np.array): x coordinates of the observation plane, given</span>
<span class="c1">#     in μm.</span>

<span class="c1">#     +  yCoords (np.array): y coordinates of the observation plane, given</span>
<span class="c1">#     in μm.</span>

<span class="c1">#     +  fields  (np.array):  with shape (3, numSamples, numSamples) where</span>
<span class="c1">#     the  first  index takes values 0, 1, 2 for the x, y, and z cartesian</span>
<span class="c1">#     components  and  the second two indices are anchored to positions in</span>
<span class="c1">#     the  obervation plane according to xCoords and yCoords. The top left</span>
<span class="c1">#     corner  of  the  array  corresponds  to the lower left corner of the</span>
<span class="c1">#     observation plane.</span>

<span class="c1">#     References</span>
<span class="c1">#     ----------</span>
<span class="c1">#     +   Shen,   Fabin,  and  Anbo  Wang.  &quot;Fast-Fourier-transform  based</span>
<span class="c1">#     numerical integration method for the Rayleigh-Sommerfeld diffraction</span>
<span class="c1">#     formula.&quot; Applied optics 45, no. 6 (2006): 1102-1110.</span>
<span class="c1">#     &#39;&#39;&#39;</span>
<span class="c1">#     λ = λfree / nref</span>
<span class="c1">#     if numSamples == &#39;auto&#39;:</span>
<span class="c1">#         numSamples = round(2*Lobs/λ)</span>
<span class="c1">#     else:</span>
<span class="c1">#         numSamples = numSamples</span>
<span class="c1">#     fields = np.zeros((3, numSamples, numSamples), dtype=complex)</span>
<span class="c1">#     for field_idx, apertureFunction in enumerate(apertureFunctions):</span>
<span class="c1">#         (numSamples, xCoords, yCoords, field) = scalarfieldprop(Lobs, z, apertureFunction, λfree, nref, numSamples)</span>
<span class="c1">#         fields[field_idx] = field</span>
<span class="c1">#     return (numSamples, xCoords, yCoords, fields)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">doubleSlit</span><span class="p">(</span><span class="n">separation</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">apertureFun</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">phase</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span>
                        <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">separation</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">separation</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
                         <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">apertureFun</span>

<span class="n">slitSep</span> <span class="o">=</span> <span class="mf">4.</span>
<span class="n">slitWidth</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">slitHeight</span> <span class="o">=</span> <span class="mf">10.</span>
<span class="n">Lobs</span> <span class="o">=</span> <span class="mf">100.</span>
<span class="n">z</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">nref</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">λfree</span> <span class="o">=</span> <span class="mf">0.532</span>
<span class="n">numSamples</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>

<span class="n">apFunx</span> <span class="o">=</span> <span class="n">doubleSlit</span><span class="p">(</span><span class="n">slitSep</span><span class="p">,</span> <span class="n">slitWidth</span><span class="p">,</span> <span class="n">slitHeight</span><span class="p">)</span>
<span class="n">apFuny</span> <span class="o">=</span> <span class="n">doubleSlit</span><span class="p">(</span><span class="n">slitSep</span><span class="p">,</span> <span class="n">slitWidth</span><span class="p">,</span> <span class="n">slitHeight</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span>
<span class="n">apFunz</span> <span class="o">=</span> <span class="n">doubleSlit</span><span class="p">(</span><span class="n">slitSep</span><span class="p">,</span> <span class="n">slitWidth</span><span class="p">,</span> <span class="n">slitHeight</span><span class="p">)</span>
<span class="n">apFunz</span><span class="o">.</span><span class="n">null</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">apFuns</span> <span class="o">=</span> <span class="p">(</span><span class="n">apFunx</span><span class="p">,</span> <span class="n">apFuny</span><span class="p">,</span> <span class="n">apFunz</span><span class="p">)</span>

<span class="c1"># Estimate the diffraction pattern from the simplified formula</span>
<span class="n">diforders</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">xmaxi</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">diforder</span> <span class="ow">in</span> <span class="n">diforders</span><span class="p">:</span>
    <span class="n">stheta</span> <span class="o">=</span> <span class="n">diforder</span> <span class="o">*</span> <span class="n">λfree</span> <span class="o">/</span> <span class="n">slitSep</span>
    <span class="k">if</span> <span class="n">stheta</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">stheta</span><span class="p">)</span>
        <span class="n">xdif</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xdif</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">Lobs</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">xmaxi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xdif</span><span class="p">)</span>
            <span class="n">xmaxi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">xdif</span><span class="p">)</span>


<span class="n">numSamples</span><span class="p">,</span> <span class="n">xCoords</span><span class="p">,</span> <span class="n">yCoords</span><span class="p">,</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">vectorfieldprop</span><span class="p">(</span><span class="n">Lobs</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">apFuns</span><span class="p">,</span> <span class="n">λfree</span><span class="p">,</span> <span class="n">nref</span><span class="p">,</span> <span class="n">numSamples</span><span class="p">)</span>

<span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">xCoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xCoords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yCoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yCoords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="k">for</span> <span class="n">field_idx</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
    <span class="n">pField</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="n">field_idx</span><span class="p">])</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">field_idx</span><span class="p">]</span>
    <span class="n">maxi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pField</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pField</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmr</span><span class="o">.</span><span class="n">wildfire</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=-</span><span class="n">maxi</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">maxi</span><span class="p">,</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;spline16&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xmaxi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xmaxi</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x/μm&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y/μm&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Diffraction pattern of a double slit | Re(F_</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">s=</span><span class="si">%.2f</span><span class="s1">μm | w=</span><span class="si">%.2f</span><span class="s1">μm | L=</span><span class="si">%.2f</span><span class="s1">μm | Δz=</span><span class="si">%.2f</span><span class="s1">μm&#39;</span> <span class="o">%</span> <span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">field_idx</span><span class="p">],</span> <span class="n">slitWidth</span><span class="p">,</span> <span class="n">slitWidth</span><span class="p">,</span> <span class="n">slitHeight</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_33_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_33_0.png" style="width: 1172px; height: 581px;" />
</div>
</div>
</section>
<section id="###Farfield-propagation">
<h3>###Farfield propagation<a class="headerlink" href="####Farfield-propagation" title="Link to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[311]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">field</span>    <span class="o">=</span> <span class="n">Eref</span>
<span class="n">replicas</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">L</span>        <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="mi">2</span> <span class="c1"># lateral extension of the field, assumed square</span>
<span class="n">dz</span>       <span class="o">=</span> <span class="mi">10</span> <span class="c1"># farfield axial resolution</span>
<span class="n">farfield_extent</span> <span class="o">=</span> <span class="mf">1000.</span>
<span class="n">λmedium</span>         <span class="o">=</span> <span class="n">λfree</span>
<span class="n">field</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">from_cyl_cart_to_cart_cart</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
<span class="n">farfield_zaxis</span><span class="p">,</span> <span class="n">farfield</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">farfield_projector</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">λfree</span><span class="p">,</span> <span class="n">farfield_extent</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">replicas</span><span class="o">=</span><span class="n">replicas</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[341]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># simply grab the xz plane</span>
<span class="n">mid_lateral_index</span> <span class="o">=</span> <span class="n">farfield</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">xz_field</span> <span class="o">=</span> <span class="n">farfield</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">mid_lateral_index</span><span class="p">]</span>
<span class="n">xz_energy_density</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xz_field</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">extra_b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">replicas</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[352]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>mkdir<span class="w"> </span>someplots
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[356]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">farfield</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">last_field</span> <span class="o">=</span> <span class="n">farfield</span><span class="p">[:,</span><span class="n">idx</span><span class="p">,:,:]</span>
    <span class="n">last_field_energy_density</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">last_field</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">stridx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">last_field_energy_density</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">ember</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./someplots/farfield_</span><span class="si">{</span><span class="n">stridx</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[354]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>open<span class="w"> </span>.
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[339]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nearfield_density</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">diameter_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">nearfield_density</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">diameter_density</span> <span class="o">=</span> <span class="n">nearfield_density</span><span class="p">[</span><span class="n">nearfield_density</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,:]</span>
<span class="n">diameter_density</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">diameter_density</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[340]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">xz_energy_density</span><span class="p">,</span>
           <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">extra_b</span><span class="p">,</span> <span class="n">extra_b</span> <span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">farfield_zaxis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
           <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
           <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">ember</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">diameter_axis</span><span class="p">,</span> <span class="n">diameter_density</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;wo&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;|E_incident|^2&#39;</span><span class="p">)</span>
<span class="c1"># plt.xlim(-10, 10)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x/µm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;z/µm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_41_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_41_0.png" style="width: 189px; height: 591px;" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[327]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">farfield</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[334]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span><span class="s1">&#39;wx&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_43_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_43_0.png" style="width: 620px; height: 195px;" />
</div>
</div>
</section>
<section id="###Angular-Spectrum-Farfield-Approximator">
<h3>###Angular-Spectrum Farfield Approximator<a class="headerlink" href="####Angular-Spectrum-Farfield-Approximator" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[389]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fiber_sol</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;eigenbasis-FG050LGA.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
<span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;coord_layout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">coordinate_layout</span><span class="p">(</span><span class="n">fiber_sol</span><span class="p">)</span>
<span class="n">totalModes</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;totalModes&#39;</span><span class="p">]</span>
<span class="n">λfree</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;free_space_wavelength&#39;</span><span class="p">]</span>
<span class="n">eigenbasis</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;eigenbasis&#39;</span><span class="p">]</span>
<span class="n">nCore</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;nCore&#39;</span><span class="p">]</span>
<span class="n">nCladding</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;nCladding&#39;</span><span class="p">]</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Δs</span><span class="p">,</span> <span class="n">xrange</span><span class="p">,</span> <span class="n">yrange</span><span class="p">,</span> <span class="n">ρrange</span><span class="p">,</span> <span class="n">φrange</span><span class="p">,</span> <span class="n">Xg</span><span class="p">,</span> <span class="n">Yg</span><span class="p">,</span> <span class="n">ρg</span><span class="p">,</span> <span class="n">φg</span><span class="p">,</span> <span class="n">nxy</span><span class="p">,</span> <span class="n">crossMask</span><span class="p">,</span> <span class="n">numSamples</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;coord_layout&#39;</span><span class="p">]</span>

<span class="n">indexPercent</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indexPercent</span> <span class="o">*</span> <span class="n">totalModes</span><span class="p">)</span>
<span class="n">nFree</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;nFree&#39;</span><span class="p">]</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">annotations</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
<span class="c1"># pick the E and H fields</span>
<span class="n">Einc</span> <span class="o">=</span> <span class="n">eigenbasis</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
<span class="n">Hinc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">eigenbasis</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:])</span>
<span class="n">kref</span><span class="p">,</span> <span class="n">Eref</span><span class="p">,</span> <span class="n">Href</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">poyntingrefractor</span><span class="p">(</span><span class="n">Einc</span><span class="p">,</span> <span class="n">Hinc</span><span class="p">,</span> <span class="n">nFree</span><span class="p">,</span> <span class="n">nxy</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Calculating the Poynting vector field...
Calculating the magnitude of the Poynting field...
Calculating the transverse component of the Poynting field...
Calculating the unit vector in the direction of the Poynting vector...
Calculating the angle of incidence field...
Calculating the angle of refraction field...
Calculating the Fresnel coefficients...
Calculating the ζ of the local coord system...
Calculating the S and P component of the incident electric field...
Calculating the S and P component of the refracted electric field...
Calculating the total refracted electric field...
Calculating the refracted wavevector (normalized) field...
Calculating the refracted H field...
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[390]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">field</span> <span class="o">=</span> <span class="n">Eref</span>
<span class="n">field</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">from_cyl_cart_to_cart_cart</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[391]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">λfree</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;free_space_wavelength&#39;</span><span class="p">]</span>
<span class="n">nMedium</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;nFree&#39;</span><span class="p">]</span>
<span class="n">Zi</span>    <span class="o">=</span> <span class="mi">0</span>
<span class="n">Zf</span>    <span class="o">=</span> <span class="mi">100</span>
<span class="n">si</span>    <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">b</span> <span class="c1"># the size of the nearfield</span>
<span class="n">sf</span>    <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">si</span> <span class="c1"># the size of the farfield</span>
<span class="n">Efar</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">angular_farfield_propagator</span><span class="p">(</span><span class="n">Eref</span><span class="p">,</span> <span class="n">λfree</span><span class="p">,</span> <span class="n">nMedium</span><span class="p">,</span> <span class="n">Zf</span><span class="p">,</span> <span class="n">Zi</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">sf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[392]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plotField</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Efar</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">sf</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">sf</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">sf</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">sf</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ishow</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">plotField</span><span class="p">,</span>
           <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
           <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">ember</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ishow</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;neither&#39;</span><span class="p">)</span>
<span class="n">circle</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">a</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x/µm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y/µm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;|Efar|^2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_48_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_48_0.png" style="width: 599px; height: 557px;" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[384]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot a general layout of what is being propagatd</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="n">si</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">si</span><span class="o">/</span><span class="mi">2</span><span class="p">],[</span><span class="n">Zi</span><span class="p">,</span><span class="n">Zi</span><span class="p">],</span><span class="s1">&#39;w:&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="n">sf</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">sf</span><span class="o">/</span><span class="mi">2</span><span class="p">],[</span><span class="n">Zf</span><span class="p">,</span><span class="n">Zf</span><span class="p">],</span><span class="s1">&#39;w--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x/µm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;z/µm&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_49_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_49_0.png" style="width: 390px; height: 267px;" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[387]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plotField</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">field</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># plotField = np.real(Eref[2])</span>
<span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ishow</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">plotField</span><span class="p">,</span>
           <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
           <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">ember</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ishow</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;neither&#39;</span><span class="p">)</span>
<span class="n">circle</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">a</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x/µm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y/µm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;|(E_near)|^2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_50_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_50_0.png" style="width: 570px; height: 574px;" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[393]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[393]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([0.        , 0.11111111, 0.22222222, 0.33333333, 0.44444444,
       0.55555556, 0.66666667, 0.77777778, 0.88888889, 1.        ])
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[395]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fiber_sol</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;eigenbasis-FG050LGA.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
<span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;coord_layout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">coordinate_layout</span><span class="p">(</span><span class="n">fiber_sol</span><span class="p">)</span>
<span class="n">totalModes</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;totalModes&#39;</span><span class="p">]</span>
<span class="n">λfree</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;free_space_wavelength&#39;</span><span class="p">]</span>
<span class="n">eigenbasis</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;eigenbasis&#39;</span><span class="p">]</span>
<span class="n">nCore</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;nCore&#39;</span><span class="p">]</span>
<span class="n">nCladding</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;nCladding&#39;</span><span class="p">]</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Δs</span><span class="p">,</span> <span class="n">xrange</span><span class="p">,</span> <span class="n">yrange</span><span class="p">,</span> <span class="n">ρrange</span><span class="p">,</span> <span class="n">φrange</span><span class="p">,</span> <span class="n">Xg</span><span class="p">,</span> <span class="n">Yg</span><span class="p">,</span> <span class="n">ρg</span><span class="p">,</span> <span class="n">φg</span><span class="p">,</span> <span class="n">nxy</span><span class="p">,</span> <span class="n">crossMask</span><span class="p">,</span> <span class="n">numSamples</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;coord_layout&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[406]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">farfields</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">annots</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">indexPercent</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">25</span><span class="p">)):</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indexPercent</span> <span class="o">*</span> <span class="n">totalModes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">indexPercent</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">totalModes</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">nFree</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;nFree&#39;</span><span class="p">]</span>
    <span class="n">annot</span> <span class="o">=</span> <span class="n">annotations</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">annots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>
    <span class="c1"># pick the E and H fields</span>
    <span class="n">Einc</span> <span class="o">=</span> <span class="n">eigenbasis</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">Hinc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">eigenbasis</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:])</span>
    <span class="n">kref</span><span class="p">,</span> <span class="n">Eref</span><span class="p">,</span> <span class="n">Href</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">poyntingrefractor</span><span class="p">(</span><span class="n">Einc</span><span class="p">,</span> <span class="n">Hinc</span><span class="p">,</span> <span class="n">nFree</span><span class="p">,</span> <span class="n">nxy</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">Eref</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">from_cyl_cart_to_cart_cart</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="n">λfree</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;free_space_wavelength&#39;</span><span class="p">]</span>
    <span class="n">nMedium</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;nFree&#39;</span><span class="p">]</span>
    <span class="n">Zi</span>    <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Zf</span>    <span class="o">=</span> <span class="mi">100</span>
    <span class="n">si</span>    <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">b</span> <span class="c1"># the size of the nearfield</span>
    <span class="n">sf</span>    <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">si</span> <span class="c1"># the size of the farfield</span>
    <span class="n">Efar</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">angular_farfield_propagator</span><span class="p">(</span><span class="n">Eref</span><span class="p">,</span> <span class="n">λfree</span><span class="p">,</span> <span class="n">nMedium</span><span class="p">,</span> <span class="n">Zf</span><span class="p">,</span> <span class="n">Zi</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">sf</span><span class="p">)</span>
    <span class="n">farfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Efar</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "25cb7b87570c4e3f8fc08e15f9faa926", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
ATTENTION: 91.9 = (rmax - rmin) / λmedium &gt; 1. The angular spectrum approximation is problematic.
Consider decreasing si, decreasing sf, or increasing Zf.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[414]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">sf</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">sf</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">sf</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">sf</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
        <span class="n">Efar</span> <span class="o">=</span> <span class="n">farfields</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">5</span><span class="o">+</span><span class="n">j</span><span class="p">]</span>
        <span class="n">plotField</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Efar</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ishow</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">plotField</span><span class="p">,</span>
                <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(),</span>
                <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">ember</span><span class="p">)</span>
        <span class="c1">#fig.colorbar(ishow, ax=ax, extend=&#39;neither&#39;)</span>
        <span class="c1"># circle = Circle((0,0), a, linestyle=&#39;--&#39;,</span>
        <span class="c1">#                 edgecolor=&#39;white&#39;,</span>
        <span class="c1">#                 facecolor=&#39;none&#39;,</span>
        <span class="c1">#                 alpha=0.5, linewidth=0.5)</span>
        <span class="c1"># ax.add_patch(circle)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x/µm&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y/µm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/juan/opt/anaconda3/lib/python3.8/site-packages/matplotlib/image.py:446: UserWarning: Warning: converting a masked element to nan.
  dv = np.float64(self.norm.vmax) - np.float64(self.norm.vmin)
/Users/juan/opt/anaconda3/lib/python3.8/site-packages/matplotlib/image.py:453: UserWarning: Warning: converting a masked element to nan.
  a_min = np.float64(newmin)
/Users/juan/opt/anaconda3/lib/python3.8/site-packages/matplotlib/image.py:458: UserWarning: Warning: converting a masked element to nan.
  a_max = np.float64(newmax)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_54_1.png" class="no-scaled-link" src="_images/wavesight-savepoint_54_1.png" style="width: 1173px; height: 1131px;" />
</div>
</div>
<section id="####Playing-around-with-DFT">
<h4>####Playing around with DFT<a class="headerlink" href="#####Playing-around-with-DFT" title="Link to this heading">¶</a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[243]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numSamples</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">dummyx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">numSamples</span><span class="p">)</span>
<span class="c1"># on this domain let&#39;s sample a function which is sin(k*x)</span>
<span class="c1"># with k = 2\</span>
<span class="n">dummyy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dummyx</span><span class="p">)</span>
<span class="n">spatialFrequencies</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">numSamples</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dummyx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">dummyx</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">discreteTransform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">dummyy</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dummyx</span><span class="p">,</span> <span class="n">dummyy</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spatialFrequencies</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">discreteTransform</span><span class="p">),</span><span class="s1">&#39;o-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_56_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_56_0.png" style="width: 386px; height: 248px;" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_56_1.png" class="no-scaled-link" src="_images/wavesight-savepoint_56_1.png" style="width: 368px; height: 248px;" />
</div>
</div>
</section>
<section id="####Spaguetti-code">
<h4>####Spaguetti code<a class="headerlink" href="#####Spaguetti-code" title="Link to this heading">¶</a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># given a field (Ex, Ey, Ez) at a plane calculate the discrete</span>
<span class="c1"># fourier transform of the field in the x,y,z directions</span>
<span class="c1"># this would provide the field in the frequency domain</span>
<span class="c1"># the field is assumed to be periodic in the x,y,z directions</span>
<span class="n">fiberfield_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">eigenbasis</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:,:])</span>
<span class="c1"># at the moment I haven&#39;t calculate the z component of the field</span>
<span class="c1"># let me just assume a z component that is roughly of the same magnitude</span>
<span class="c1"># of the x and y components, that starts normal at the center and</span>
<span class="c1"># deviates to the NA of the fiber at the edge of it</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Ex</span> <span class="o">=</span> <span class="n">fiberfield_t</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span>
<span class="n">Ey</span> <span class="o">=</span> <span class="n">fiberfield_t</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:]</span>
<span class="n">NA</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;NA&#39;</span><span class="p">]</span>
<span class="n">nCore</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;nCore&#39;</span><span class="p">]</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;coreRadius&#39;</span><span class="p">]</span>
<span class="n">thetamax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">NA</span><span class="o">/</span><span class="n">nCore</span><span class="p">)</span>
<span class="c1"># calculate the magnitude of the transverse field</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Xg</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Yg</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># calculate the angle of E at each point</span>
<span class="n">launchAngle</span> <span class="o">=</span> <span class="n">thetamax</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">r</span>
<span class="c1"># knowing the angle at each position I should be able to &quot;calculate&quot;</span>
<span class="c1"># the z component of the field</span>
<span class="c1"># this doesn&#39;t make any sense, the direction of the</span>
<span class="c1"># electric field is not the direction of the wave vector</span>
<span class="c1"># ok, instead let me estimate the direction of the wave vector</span>
<span class="c1"># across the fiber and then use that together with the field at</span>
<span class="c1"># each position to determine what is a compatible value for the z component</span>
<span class="n">kmag</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">λfree</span><span class="o">*</span><span class="n">nCore</span>
<span class="n">dirfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">Yg</span><span class="p">,</span> <span class="n">Xg</span><span class="p">)</span>
<span class="n">xhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dirfield</span><span class="p">)</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dirfield</span><span class="p">)</span>
<span class="n">kz</span> <span class="o">=</span> <span class="n">kmag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">launchAngle</span><span class="p">)</span>
<span class="n">kx</span> <span class="o">=</span> <span class="n">kmag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">launchAngle</span><span class="p">)</span> <span class="o">*</span> <span class="n">xhat</span>
<span class="n">ky</span> <span class="o">=</span> <span class="n">kmag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">launchAngle</span><span class="p">)</span> <span class="o">*</span> <span class="n">yhat</span>
<span class="c1"># at every point</span>
<span class="c1"># now let me make</span>
<span class="c1"># use this to calculate a possible z component for E</span>
<span class="n">dotEk</span> <span class="o">=</span> <span class="n">fiberfield_t</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">kx</span> <span class="o">+</span> <span class="n">fiberfield_t</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">ky</span>
<span class="n">Ez</span> <span class="o">=</span> <span class="o">-</span><span class="n">dotEk</span><span class="o">/</span><span class="n">kz</span>
<span class="c1"># in this construction the electric field is always in parallel to the plane of incidence</span>
<span class="n">fresnel</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nCore</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">launchAngle</span><span class="p">)</span>
           <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">launchAngle</span><span class="p">)</span> <span class="o">+</span> <span class="n">nCore</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nCore</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">launchAngle</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
<span class="n">Erefracted_x</span> <span class="o">=</span> <span class="n">fresnel</span> <span class="o">*</span> <span class="n">Ex</span>
<span class="n">Erefracted_y</span> <span class="o">=</span> <span class="n">fresnel</span> <span class="o">*</span> <span class="n">Ey</span>
<span class="n">Erefracted_z</span> <span class="o">=</span> <span class="n">fresnel</span> <span class="o">*</span> <span class="n">Ez</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Erefracted_x</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_60_0.png" src="_images/wavesight-savepoint_60_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ok, next part</span>
<span class="c1"># i need to find the farfield for the refracted field</span>
<span class="c1"># i think I have</span>
<span class="n">apertureRadius</span> <span class="o">=</span> <span class="n">b</span>
<span class="n">λ</span> <span class="o">=</span> <span class="n">λfree</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">λ</span>
<span class="n">replicas</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">dist_to_ML</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">zmax</span> <span class="o">=</span> <span class="n">dist_to_ML</span> <span class="o">*</span> <span class="mi">5</span>
<span class="n">farfield_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">zmax</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
<span class="n">L</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">apertureRadius</span> <span class="c1"># spatial extent of the field</span>
<span class="n">field</span> <span class="o">=</span> <span class="n">Erefracted_x</span>
<span class="n">dx</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">idx_width</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="n">replicas</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">nearfourier</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">field</span><span class="p">,(</span><span class="n">idx_width</span><span class="p">,</span> <span class="n">idx_width</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">field</span>
<span class="n">kx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="o">=</span><span class="n">dx</span><span class="p">))</span>
<span class="n">ky</span> <span class="o">=</span> <span class="n">kx</span>
<span class="n">kx</span><span class="p">,</span> <span class="n">ky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="p">)</span>
<span class="n">kz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">kx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">ky</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">0</span><span class="n">j</span><span class="p">)</span>

<span class="n">gator</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">farfield_axis</span><span class="p">,</span> <span class="n">kz</span><span class="p">)</span>
<span class="n">gator</span> <span class="o">=</span> <span class="n">gator</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">*</span><span class="n">farfield_axis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="o">*</span><span class="n">kz</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">gator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">gator</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">NA</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
12.709032994395436
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gator</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(100, 362, 362)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">farfields</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">fields</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ex&#39;</span><span class="p">:</span><span class="n">Erefracted_x</span><span class="p">,</span> <span class="s1">&#39;ey&#39;</span><span class="p">:</span><span class="n">Erefracted_y</span><span class="p">}</span>
<span class="k">for</span> <span class="n">field_component</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ex&#39;</span><span class="p">,</span><span class="s1">&#39;ey&#39;</span><span class="p">]:</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">field_component</span><span class="p">]</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">idx_width</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">field</span>
    <span class="c1"># calculate the Fourier transform of the nearfield</span>
    <span class="n">nearfourier</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <span class="c1"># multiply by the farfield propagator</span>
    <span class="n">farfourier</span> <span class="o">=</span> <span class="n">nearfourier</span> <span class="o">*</span> <span class="n">gator</span>
    <span class="c1"># calculate the inverse Fourier transform</span>
    <span class="n">farfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">farfourier</span><span class="p">)</span>

    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">L</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">replicas</span><span class="p">,</span> <span class="n">L</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">replicas</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">zmax</span><span class="p">]</span>
    <span class="c1"># get the field on the zx plane</span>
    <span class="n">pfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">farfield</span><span class="p">[::,</span><span class="n">farfield</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">farfields</span><span class="p">[</span><span class="n">field_component</span><span class="p">]</span> <span class="o">=</span> <span class="n">pfield</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pfield</span><span class="p">,</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmr</span><span class="o">.</span><span class="n">ember</span><span class="p">,</span>
            <span class="n">extent</span> <span class="o">=</span> <span class="n">extent</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="n">L</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">L</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x/$\mu$m&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;z/$\mu$m&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;|</span><span class="si">%s</span><span class="s1">|^2&#39;</span> <span class="o">%</span> <span class="n">field_component</span><span class="p">)</span>
<span class="c1">#     plt.colorbar()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_64_0.png" src="_images/wavesight-savepoint_64_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_64_1.png" src="_images/wavesight-savepoint_64_1.png" />
</div>
</div>
</section>
</section>
<section id="###Poynting-vectors-and-angles-of-incidence">
<h3>###Poynting vectors and angles of incidence<a class="headerlink" href="####Poynting-vectors-and-angles-of-incidence" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;dark_background&#39;</span><span class="p">)</span>
<span class="n">component_index</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Et_ρ&quot;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Et_ϕ&quot;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;Ht_ρ&quot;</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Ht_ϕ&quot;</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)}</span>
<span class="n">index</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">extent</span>  <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="o">-</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
<span class="k">for</span> <span class="n">fun_picker</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">]:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">fun_picker</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">]:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">watermelon</span>
        <span class="k">if</span> <span class="n">fun_picker</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">:</span>
            <span class="n">title_format</span> <span class="o">=</span> <span class="s1">&#39;Re{</span><span class="si">%s</span><span class="s1">}&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title_format</span> <span class="o">=</span> <span class="s1">&#39;Im{</span><span class="si">%s</span><span class="s1">}&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ember</span>
        <span class="n">title_format</span> <span class="o">=</span> <span class="s1">&#39;|</span><span class="si">%s</span><span class="s1">|&#39;</span>
    <span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">ci</span> <span class="ow">in</span> <span class="n">component_index</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">field</span>   <span class="o">=</span> <span class="n">eigenbasis</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">ci</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ci</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">field</span>   <span class="o">=</span> <span class="n">fun_picker</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">fun_picker</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fun_picker</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">:</span>
                <span class="n">fun_picker</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span>
                <span class="n">title_format</span> <span class="o">=</span> <span class="s1">&#39;Im{</span><span class="si">%s</span><span class="s1">}&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fun_picker</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span>
                <span class="n">title_format</span> <span class="o">=</span> <span class="s1">&#39;Re{</span><span class="si">%s</span><span class="s1">}&#39;</span>
            <span class="n">field</span>   <span class="o">=</span> <span class="n">eigenbasis</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">ci</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ci</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">field</span>   <span class="o">=</span> <span class="n">fun_picker</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ci</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ci</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">fun_picker</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">]:</span>
            <span class="n">themax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">themax</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="o">-</span><span class="n">themax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">iplot</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">field</span><span class="p">,</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
                <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x/µm&#39;</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y/µm&#39;</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_format</span> <span class="o">%</span> <span class="n">component</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">annotations</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axis</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">annotations</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axis</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
        <span class="n">circle</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">a</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
        <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">iplot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_66_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_66_0.png" style="width: 713px; height: 567px;" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_66_1.png" class="no-scaled-link" src="_images/wavesight-savepoint_66_1.png" style="width: 713px; height: 567px;" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># coord_layout = coordinate_layout(fiber_sol)</span>
<span class="c1"># a, b, Δs, xrange, yrange, ρrange, φrange, Xg, Yg, ρg, φg, nxy, crossMask = coord_layout</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # get a mode</span>
<span class="c1"># index = 30</span>
<span class="c1"># Efield = eigenbasis[index, 0, :, :, :]</span>
<span class="c1"># Hfield = np.conjugate(eigenbasis[index, 1, :, :, :])</span>

<span class="c1"># # #EXH-Calc</span>
<span class="c1"># Sfield = 0.5*np.real(np.cross(Efield, Hfield, axis=0))</span>

<span class="c1"># # #normIncident-Calc</span>
<span class="c1"># Sfieldmag = np.sqrt(Sfield[0,:,:]**2 + Sfield[1,:,:]**2 + Sfield[2,:,:]**2)</span>
<span class="c1"># Stransverse = np.sqrt(Sfield[0,:,:]**2 + Sfield[1,:,:]**2)</span>
<span class="c1"># dirField = np.arctan2(Stransverse,</span>
<span class="c1">#                       Sfield[2, :, :])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">implot</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dirField</span><span class="p">,</span>
           <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
           <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">ember</span><span class="p">)</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">circle</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">a</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x/µm&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y/µm&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;|β|&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">implot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
<span class="n">implot</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Sfieldmag</span><span class="p">,</span>
           <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
           <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">ember</span><span class="p">)</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">circle</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">a</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x/µm&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y/µm&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;|S|&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">implot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">midindex</span> <span class="o">=</span> <span class="n">dirField</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span>
<span class="n">diameter</span> <span class="o">=</span> <span class="n">dirField</span><span class="p">[</span><span class="n">midindex</span><span class="p">]</span>
<span class="n">ρfull</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">dirField</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ρfull</span><span class="p">,</span> <span class="n">diameter</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x/µm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;β/°&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_70_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_70_0.png" style="width: 717px; height: 261px;" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
<span class="n">Efield</span> <span class="o">=</span> <span class="n">eigenbasis</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
<span class="n">Hfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">eigenbasis</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Efield</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Efield</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Efield</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.9999999
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dotprod</span> <span class="o">=</span> <span class="p">(</span><span class="n">Efield</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">Hfield</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">Efield</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">Hfield</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">Efield</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">Hfield</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
<span class="n">dotprod</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Efield</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Hfield</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">dotangle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dotprod</span><span class="p">))</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dotangle</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_73_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_73_0.png" style="width: 307px; height: 248px;" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Efield = eigenbasis[index, 0, :, :, :]</span>
<span class="c1"># Hfield = np.conjugate(eigenbasis[index, 1, :, :, :])</span>
<span class="c1"># Sfield = 0.5*np.real(np.cross(Efield, Hfield, axis=0))</span>
<span class="c1"># Sfieldmag = np.sqrt(Sfield[0,:,:]**2 + Sfield[1,:,:]**2 + Sfield[2,:,:]**2)</span>
<span class="c1"># Stransverse = np.sqrt(Sfield[0,:,:]**2 + Sfield[1,:,:]**2)</span>
<span class="c1"># dirField = np.arctan2(Stransverse,</span>
<span class="c1">#                       Sfield[2, :, :])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[418]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Δs</span><span class="p">,</span> <span class="n">xrange</span><span class="p">,</span> <span class="n">yrange</span><span class="p">,</span> <span class="n">ρrange</span><span class="p">,</span> <span class="n">φrange</span><span class="p">,</span> <span class="n">Xg</span><span class="p">,</span> <span class="n">Yg</span><span class="p">,</span> <span class="n">ρg</span><span class="p">,</span> <span class="n">φg</span><span class="p">,</span> <span class="n">nxy</span><span class="p">,</span> <span class="n">crossMask</span><span class="p">,</span> <span class="n">numSamples</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;coord_layout&#39;</span><span class="p">]</span>
<span class="n">eigenbasis</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;eigenbasis&#39;</span><span class="p">]</span>
<span class="n">totalModes</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;totalModes&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[136]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">βfield</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="p">,</span>
          <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">ember</span><span class="p">,</span>
          <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">a</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x/µm&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y/µm&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;β_incident / º -- &#39;</span> <span class="o">+</span> <span class="n">annot</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">θfield</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="p">,</span>
          <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">ember</span><span class="p">,</span>
          <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">a</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x/µm&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y/µm&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;θ_refracted / º -- &#39;</span> <span class="o">+</span> <span class="n">annot</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_76_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_76_0.png" style="width: 609px; height: 1147px;" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[285]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get a mode</span>
<span class="n">indexPercent</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indexPercent</span> <span class="o">*</span> <span class="n">totalModes</span><span class="p">)</span>
<span class="n">nFree</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">annotations</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
<span class="c1"># pick the E and H fields</span>
<span class="n">Efield</span> <span class="o">=</span> <span class="n">eigenbasis</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
<span class="n">Hfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">eigenbasis</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:])</span>

<span class="c1"># #EXH-Calc</span>
<span class="c1"># calculate the Poynting vector</span>
<span class="n">Sfield</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Efield</span><span class="p">,</span> <span class="n">Hfield</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>


<span class="c1"># #normIncidentk-Calc</span>
<span class="c1"># calculate the magnitude of the Poynting field</span>
<span class="n">Sfieldmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Sfield</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="c1"># calculate the transverse component of the Poynting vector</span>
<span class="n">Stransverse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Sfield</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Sfield</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># calculate the direction of the Poynting vector use that to estimate angles of incidence</span>
<span class="c1"># here it&#39;s assumed that the normal is pointing in the +z direction</span>
<span class="c1"># #β-Calc</span>
<span class="n">βfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">Stransverse</span><span class="p">,</span> <span class="n">Sfield</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
<span class="c1"># #θ-Calc</span>
<span class="n">θfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">nxy</span><span class="o">/</span><span class="n">nFree</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">βfield</span><span class="p">))</span>
<span class="c1"># calculate the unit vector in the direction of the Poynting vector</span>
<span class="n">kfield</span> <span class="o">=</span> <span class="n">Sfield</span> <span class="o">/</span> <span class="n">Sfieldmag</span>
<span class="n">numNans_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">kfield</span><span class="p">))</span>
<span class="n">numNans_β</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">βfield</span><span class="p">))</span>
<span class="n">numNans_θ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">θfield</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;kfield has </span><span class="si">{}</span><span class="s2"> NaNs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numNans_k</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;βfield has </span><span class="si">{}</span><span class="s2"> NaNs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numNans_β</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;θfield has </span><span class="si">{}</span><span class="s2"> NaNs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numNans_θ</span><span class="p">))</span>

<span class="c1"># #FresnelS-Calc</span>
<span class="c1"># #FresnelP-Calc</span>
<span class="c1"># These I can calculate using the refractive indices and the angles of incidence</span>
<span class="c1"># S is perpendicular to plane of incidence</span>
<span class="n">fresnelS</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nxy</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">βfield</span><span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span> <span class="n">nxy</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">βfield</span><span class="p">)</span>
               <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nFree</span><span class="o">**</span><span class="mi">2</span>
                               <span class="o">-</span> <span class="n">nxy</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">βfield</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
<span class="n">fresnelP</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nFree</span> <span class="o">*</span> <span class="n">nxy</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">βfield</span><span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">nFree</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">βfield</span><span class="p">)</span>
               <span class="o">+</span>  <span class="n">nxy</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nFree</span><span class="o">**</span><span class="mi">2</span>
                          <span class="o">-</span> <span class="n">nxy</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">βfield</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>


<span class="c1"># #ζ-Calc</span>
<span class="c1"># calculate the unit vector field perpendicular to the plane of incidence</span>
<span class="c1"># which is basically k X z</span>
<span class="n">ζfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">kfield</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">ζfield</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">kfield</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ζfield</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">kfield</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># normalize the ζfield</span>
<span class="n">ζfield</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ζfield</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="c1"># decompose the field in P and S polarizations</span>
<span class="c1"># first find P-pol and then use the complement to determine S-pol</span>
<span class="c1"># the S-pol can be obtained by the dot product of E with ζ</span>
<span class="c1">#EincS-Calc</span>
<span class="n">ESdot</span> <span class="o">=</span> <span class="n">Efield</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">ζfield</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">Efield</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">ζfield</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">EincS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ζfield</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">EincS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ESdot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ζfield</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">EincS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ESdot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ζfield</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="c1">#EincP-Calc</span>
<span class="n">EincP</span> <span class="o">=</span> <span class="n">Efield</span> <span class="o">-</span> <span class="n">EincS</span>
<span class="k">del</span> <span class="n">ESdot</span>

<span class="c1">#ErefS-Calc</span>
<span class="n">ErefS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Efield</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">ErefS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fresnelS</span> <span class="o">*</span> <span class="n">EincS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ErefS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fresnelS</span> <span class="o">*</span> <span class="n">EincS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ErefS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fresnelS</span> <span class="o">*</span> <span class="n">EincS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="c1">#ErefP-Calc</span>
<span class="n">ErefP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Efield</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">ErefP</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fresnelP</span> <span class="o">*</span> <span class="n">EincP</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ErefP</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fresnelP</span> <span class="o">*</span> <span class="n">EincP</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ErefP</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fresnelP</span> <span class="o">*</span> <span class="n">EincP</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="c1">#Eref-Calc</span>
<span class="n">Eref</span>  <span class="o">=</span> <span class="n">ErefS</span> <span class="o">+</span> <span class="n">ErefP</span>

<span class="c1">#kref-Calc</span>
<span class="n">ξfield</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ζfield</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">ξfield</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">ζfield</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ξfield</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ζfield</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">kref</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">kfield</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">kref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">θfield</span><span class="p">)</span> <span class="o">*</span> <span class="n">ξfield</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">kref</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">θfield</span><span class="p">)</span> <span class="o">*</span> <span class="n">ξfield</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">kref</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">θfield</span><span class="p">)</span>

<span class="c1">#Href-Calc</span>
<span class="n">Href</span> <span class="o">=</span> <span class="n">nFree</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="n">Eref</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
kfield has 3 NaNs
βfield has 0 NaNs
θfield has 472 NaNs
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[286]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># def poyntingrefractor(Efield, Hfield, nxy, nFree, verbose=False):</span>
<span class="c1">#     &#39;&#39;&#39;</span>
<span class="c1">#     Approximate the refracted field across a planar   interface</span>
<span class="c1">#     using the Poynting vector as an analog to the wavevector of</span>
<span class="c1">#     a plane-wave.</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     Efield : np.array (3, N, M)</span>
<span class="c1">#         The electric field incident on the interface.</span>
<span class="c1">#     Hfield : np.array (3, N, M)</span>
<span class="c1">#         The H-field incident on the interface.</span>
<span class="c1">#     nxy : np.array    (N, M)</span>
<span class="c1">#         The refractive index transverse to the interface inside the incident medium.</span>
<span class="c1">#     nFree : float</span>
<span class="c1">#         The refractive index of the homogeneous refractive medium.</span>
<span class="c1">#     verbose : bool, optional</span>
<span class="c1">#         Whether to print or not progress messages, by default False.</span>
<span class="c1">#     &#39;&#39;&#39;</span>
<span class="c1">#     # #EXH-Calc</span>
<span class="c1">#     # calculate the Poynting vector</span>
<span class="c1">#     if verbose:</span>
<span class="c1">#         print(&quot;Calculating the Poynting vector field...&quot;)</span>
<span class="c1">#     Sfield = 0.5*np.real(np.cross(Efield, Hfield, axis=0))</span>

<span class="c1">#     # #normIncidentk-Calc</span>
<span class="c1">#     # calculate the magnitude of the Poynting field</span>
<span class="c1">#     if verbose:</span>
<span class="c1">#         print(&quot;Calculating the magnitude of the Poynting field...&quot;)</span>
<span class="c1">#     Sfieldmag = np.sqrt(np.sum(Sfield**2, axis=0))</span>
<span class="c1">#     if verbose:</span>
<span class="c1">#         print(&quot;Calculating the transverse component of the Poynting field...&quot;)</span>
<span class="c1">#     # calculate the unit vector in the direction of the Poynting vector</span>
<span class="c1">#     if verbose:</span>
<span class="c1">#         print(&quot;Calculating the unit vector in the direction of the Poynting vector...&quot;)</span>
<span class="c1">#     kfield = Sfield / Sfieldmag</span>
<span class="c1">#     # calculate the transverse component of the Poynting vector</span>
<span class="c1">#     Stransverse = np.sqrt(Sfield[0,:,:]**2 + Sfield[1,:,:]**2)</span>

<span class="c1">#     # #β-Calc</span>
<span class="c1">#     if verbose:</span>
<span class="c1">#         print(&quot;Calculating the angle of incidence field...&quot;)</span>
<span class="c1">#     # Assuming that the normal is pointing in the +z direction</span>
<span class="c1">#     βfield = np.arctan2(Stransverse, Sfield[2, :, :])</span>

<span class="c1">#     # #θ-Calc</span>
<span class="c1">#     if verbose:</span>
<span class="c1">#         print(&quot;Calculating the angle of refraction field...&quot;)</span>
<span class="c1">#     θfield = np.arcsin(nxy/nFree * np.sin(βfield))</span>

<span class="c1">#     # #FresnelS-Calc</span>
<span class="c1">#     if verbose:</span>
<span class="c1">#         print(&quot;Calculating the Fresnel coefficients...&quot;)</span>

<span class="c1">#     fresnelS = (2 * nxy * np.cos(βfield)</span>
<span class="c1">#                 / ( nxy * np.cos(βfield)</span>
<span class="c1">#                 + np.sqrt(nFree**2</span>
<span class="c1">#                                 - nxy**2 * np.sin(βfield)**2)</span>
<span class="c1">#                     )</span>
<span class="c1">#                 )</span>

<span class="c1">#     # #FresnelP-Calc</span>
<span class="c1">#     fresnelP = (2 * nFree * nxy * np.cos(βfield)</span>
<span class="c1">#                 / (nFree**2 * np.cos(βfield)</span>
<span class="c1">#                 +  nxy * np.sqrt(nFree**2</span>
<span class="c1">#                             - nxy**2 * np.sin(βfield)**2)</span>
<span class="c1">#                     )</span>
<span class="c1">#                 )</span>

<span class="c1">#     # #ζ-Calc</span>
<span class="c1">#     if verbose:</span>
<span class="c1">#         print(&quot;Calculating the ζ of the local coord system...&quot;)</span>
<span class="c1">#     # calculate the unit vector field perpendicular to the plane of incidence</span>
<span class="c1">#     # which is basically k X z</span>
<span class="c1">#     ζfield = np.zeros(kfield.shape)</span>
<span class="c1">#     ζfield[0] = kfield[1]</span>
<span class="c1">#     ζfield[1] = -kfield[0]</span>
<span class="c1">#     # normalize it</span>
<span class="c1">#     ζfield /= np.sqrt(np.sum(np.abs(ζfield)**2, axis=0))</span>

<span class="c1">#     # #EincS-Calc</span>
<span class="c1">#     if verbose:</span>
<span class="c1">#         print(&quot;Calculating the S and P component of the incident electric field...&quot;)</span>
<span class="c1">#     # decompose the field in P and S polarizations</span>
<span class="c1">#     # first find P-pol and then use the complement to determine S-pol</span>
<span class="c1">#     # the S-pol can be obtained by the dot product of E with ζ</span>
<span class="c1">#     ESdot = Efield[0,:,:] * ζfield[0] + Efield[1,:,:] * ζfield[1]</span>
<span class="c1">#     EincS = np.zeros(ζfield.shape)</span>
<span class="c1">#     EincS[0] = ESdot[0] * ζfield[0]</span>
<span class="c1">#     EincS[1] = ESdot[1] * ζfield[1]</span>
<span class="c1">#     # #EincP-Calc</span>
<span class="c1">#     EincP = Efield - EincS</span>
<span class="c1">#     del ESdot</span>

<span class="c1">#     # #ErefS-Calc</span>
<span class="c1">#     if verbose:</span>
<span class="c1">#         print(&quot;Calculating the S and P component of the refracted electric field...&quot;)</span>
<span class="c1">#     ErefS = np.zeros(Efield.shape)</span>
<span class="c1">#     ErefS[0] = fresnelS * EincS[0]</span>
<span class="c1">#     ErefS[1] = fresnelS * EincS[1]</span>
<span class="c1">#     ErefS[2] = fresnelS * EincS[2]</span>
<span class="c1">#     # #ErefP-Calc</span>
<span class="c1">#     ErefP = np.zeros(Efield.shape)</span>
<span class="c1">#     ErefP[0] = fresnelP * EincP[0]</span>
<span class="c1">#     ErefP[1] = fresnelP * EincP[1]</span>
<span class="c1">#     ErefP[2] = fresnelP * EincP[2]</span>
<span class="c1">#     # #Eref-Calc</span>
<span class="c1">#     if verbose:</span>
<span class="c1">#         print(&quot;Calculating the total refracted electric field...&quot;)</span>
<span class="c1">#     Eref  = ErefS + ErefP</span>

<span class="c1">#     # #kref-Calc</span>
<span class="c1">#     if verbose:</span>
<span class="c1">#         print(&quot;Calculating the refracted wavevector (normalized) field...&quot;)</span>
<span class="c1">#     ξfield    = np.zeros(ζfield.shape)</span>
<span class="c1">#     ξfield[0] = -ζfield[1]</span>
<span class="c1">#     ξfield[1] = ζfield[0]</span>
<span class="c1">#     kref      = np.zeros(kfield.shape)</span>
<span class="c1">#     kref[0]   = np.sin(θfield) * ξfield[0]</span>
<span class="c1">#     kref[1]   = np.sin(θfield) * ξfield[1]</span>
<span class="c1">#     kref[2]   = np.cos(θfield)</span>

<span class="c1">#     # #Href-Calc</span>
<span class="c1">#     if verbose:</span>
<span class="c1">#         print(&quot;Calculating the refracted H field...&quot;)</span>
<span class="c1">#     Href = nFree * np.cross(kref, Eref, axis=0)</span>

<span class="c1">#     return Eref, Href</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[419]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">indexPercent</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indexPercent</span> <span class="o">*</span> <span class="n">totalModes</span><span class="p">)</span>
<span class="n">nFree</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">annotations</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
<span class="c1"># pick the E and H fields</span>
<span class="n">Einc</span> <span class="o">=</span> <span class="n">eigenbasis</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
<span class="n">Hinc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">eigenbasis</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:])</span>
<span class="n">kref</span><span class="p">,</span> <span class="n">Eref</span><span class="p">,</span> <span class="n">Href</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">poyntingrefractor</span><span class="p">(</span><span class="n">Einc</span><span class="p">,</span> <span class="n">Hinc</span><span class="p">,</span> <span class="n">nFree</span><span class="p">,</span> <span class="n">nxy</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Calculating the Poynting vector field...
Calculating the magnitude of the Poynting field...
Calculating the transverse component of the Poynting field...
Calculating the unit vector in the direction of the Poynting vector...
Calculating the angle of incidence field...
Calculating the angle of refraction field...
Calculating the Fresnel coefficients...
Calculating the ζ of the local coord system...
Calculating the S and P component of the incident electric field...
Calculating the S and P component of the refracted electric field...
Calculating the total refracted electric field...
Calculating the refracted wavevector (normalized) field...
Calculating the refracted H field...
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[417]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate the refraction of a plane wave</span>
<span class="n">dim</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">nwg</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">nxy</span> <span class="o">=</span> <span class="n">nwg</span>  <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>
<span class="n">nFree</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">Efield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>
<span class="n">γ</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">Efield</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Efield</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">γ</span><span class="p">)</span>
<span class="n">Efield</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">γ</span><span class="p">)</span>
<span class="n">kinc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">γ</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">γ</span><span class="p">)])</span>
<span class="n">Hfield</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">kinc</span><span class="p">,</span> <span class="n">Efield</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">kref</span><span class="p">,</span> <span class="n">Eref</span><span class="p">,</span> <span class="n">Href</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">poyntingrefractor</span><span class="p">(</span><span class="n">Efield</span><span class="p">,</span> <span class="n">Hfield</span><span class="p">,</span> <span class="n">nxy</span><span class="p">,</span> <span class="n">nFree</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">kref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">kref</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">kref</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Calculating the Poynting vector field...
Calculating the magnitude of the Poynting field...
Calculating the transverse component of the Poynting field...
Calculating the unit vector in the direction of the Poynting vector...
Calculating the angle of incidence field...
Calculating the angle of refraction field...
Calculating the Fresnel coefficients...
Calculating the ζ of the local coord system...
Calculating the S and P component of the incident electric field...
Calculating the S and P component of the refracted electric field...
Calculating the total refracted electric field...
Calculating the refracted wavevector (normalized) field...
Calculating the refracted H field...
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[411]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">kref</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">kref</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">kinc</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">kinc</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_81_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_81_0.png" style="width: 380px; height: 248px;" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[344]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># dim = 500</span>
<span class="c1"># nxy = 1.5 * np.ones((dim, dim))</span>
<span class="c1"># Efield = np.zeros((3, dim, dim))</span>
<span class="c1"># Efield[0] = 1</span>
<span class="c1"># Efield[1] = 0</span>
<span class="c1"># Efield[2] = 0</span>
<span class="c1"># kinc = np.array([0,0,1])</span>
<span class="c1"># Hfield = np.cross(kinc, Efield, axis=0)</span>

<span class="c1"># # #EXH-Calc</span>
<span class="c1"># # calculate the Poynting vector</span>
<span class="c1"># Sfield = 0.5*np.real(np.cross(Efield, Hfield, axis=0))</span>


<span class="c1"># # #normIncidentk-Calc</span>
<span class="c1"># # calculate the magnitude of the Poynting field</span>
<span class="c1"># Sfieldmag = np.sqrt(np.sum(Sfield**2, axis=0))</span>
<span class="c1"># # calculate the transverse component of the Poynting vector</span>
<span class="c1"># Stransverse = np.sqrt(Sfield[0,:,:]**2 + Sfield[1,:,:]**2)</span>
<span class="c1"># # calculate the direction of the Poynting vector use that to estimate angles of incidence</span>
<span class="c1"># # here it&#39;s assumed that the normal is pointing in the +z direction</span>
<span class="c1"># # #β-Calc</span>
<span class="c1"># βfield = np.arctan2(Stransverse, Sfield[2, :, :])</span>
<span class="c1"># # #θ-Calc</span>
<span class="c1"># θfield = np.arcsin(nxy/nFree * np.sin(βfield))</span>
<span class="c1"># # calculate the unit vector in the direction of the Poynting vector</span>
<span class="c1"># kfield = Sfield / Sfieldmag</span>
<span class="c1"># numNans_k = np.sum(np.isnan(kfield))</span>
<span class="c1"># numNans_β = np.sum(np.isnan(βfield))</span>
<span class="c1"># numNans_θ = np.sum(np.isnan(θfield))</span>
<span class="c1"># print(&quot;kfield has {} NaNs&quot;.format(numNans_k))</span>
<span class="c1"># print(&quot;βfield has {} NaNs&quot;.format(numNans_β))</span>
<span class="c1"># print(&quot;θfield has {} NaNs&quot;.format(numNans_θ))</span>

<span class="c1"># # #FresnelS-Calc</span>
<span class="c1"># # #FresnelP-Calc</span>
<span class="c1"># # These I can calculate using the refractive indices and the angles of incidence</span>
<span class="c1"># # S is perpendicular to plane of incidence</span>
<span class="c1"># fresnelS = (2 * nxy * np.cos(βfield)</span>
<span class="c1">#             / ( nxy * np.cos(βfield)</span>
<span class="c1">#                + np.sqrt(nFree**2</span>
<span class="c1">#                                - nxy**2 * np.sin(βfield)**2)</span>
<span class="c1">#                 )</span>
<span class="c1">#             )</span>
<span class="c1"># fresnelP = (2 * nFree * nxy * np.cos(βfield)</span>
<span class="c1">#             / (nFree**2 * np.cos(βfield)</span>
<span class="c1">#                +  nxy * np.sqrt(nFree**2</span>
<span class="c1">#                           - nxy**2 * np.sin(βfield)**2)</span>
<span class="c1">#                 )</span>
<span class="c1">#             )</span>


<span class="c1"># # #ζ-Calc</span>
<span class="c1"># # calculate the unit vector field perpendicular to the plane of incidence</span>
<span class="c1"># # which is basically k X z</span>
<span class="c1"># ζfield = np.zeros(kfield.shape)</span>
<span class="c1"># ζfield[0] = kfield[1]</span>
<span class="c1"># ζfield[1] = -kfield[0]</span>
<span class="c1"># # normalize the ζfield</span>
<span class="c1"># ζfield /= np.sqrt(np.sum(np.abs(ζfield)**2, axis=0))</span>
<span class="c1"># # in the case of normal incidence, ζfield is undefined</span>
<span class="c1"># # so set it can be set to anything</span>
<span class="c1"># normalIncidence = (βfield == 0)</span>
<span class="c1"># ζfield[0][normalIncidence] = 1</span>
<span class="c1"># ζfield[1][normalIncidence] = 0</span>
<span class="c1"># ζfield[2][normalIncidence] = 0</span>

<span class="c1"># # decompose the field in P and S polarizations</span>
<span class="c1"># # first find P-pol and then use the complement to determine S-pol</span>
<span class="c1"># # the S-pol can be obtained by the dot product of E with ζ</span>
<span class="c1"># #EincS-Calc</span>
<span class="c1"># ESdot = Efield[0,:,:] * ζfield[0] + Efield[1,:,:] * ζfield[1]</span>
<span class="c1"># EincS = np.zeros(ζfield.shape)</span>
<span class="c1"># EincS[0] = ESdot[0] * ζfield[0]</span>
<span class="c1"># EincS[1] = ESdot[1] * ζfield[1]</span>
<span class="c1"># #EincP-Calc</span>
<span class="c1"># EincP = Efield - EincS</span>
<span class="c1"># del ESdot</span>

<span class="c1"># #ErefS-Calc</span>
<span class="c1"># ErefS = np.zeros(Efield.shape)</span>
<span class="c1"># ErefS[0] = fresnelS * EincS[0]</span>
<span class="c1"># ErefS[1] = fresnelS * EincS[1]</span>
<span class="c1"># ErefS[2] = fresnelS * EincS[2]</span>

<span class="c1"># #ErefP-Calc</span>
<span class="c1"># ErefP = np.zeros(Efield.shape)</span>
<span class="c1"># ErefP[0] = fresnelP * EincP[0]</span>
<span class="c1"># ErefP[1] = fresnelP * EincP[1]</span>
<span class="c1"># ErefP[2] = fresnelP * EincP[2]</span>

<span class="c1"># #Eref-Calc</span>
<span class="c1"># Eref  = ErefS + ErefP</span>

<span class="c1"># #kref-Calc</span>
<span class="c1"># ξfield    = np.zeros(ζfield.shape)</span>
<span class="c1"># ξfield[0] = -ζfield[1]</span>
<span class="c1"># ξfield[1] = ζfield[0]</span>
<span class="c1"># kref      = np.zeros(kfield.shape)</span>
<span class="c1"># kref[0]   = np.sin(θfield) * ξfield[0]</span>
<span class="c1"># kref[1]   = np.sin(θfield) * ξfield[1]</span>
<span class="c1"># kref[2]   = np.cos(θfield)</span>

<span class="c1"># #Href-Calc</span>
<span class="c1"># Href = nFree * np.cross(kref, Eref, axis=0)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
kfield has 0 NaNs
βfield has 0 NaNs
θfield has 0 NaNs
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[345]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Eref</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[345]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[[1.2, 1.2, 1.2, ..., 1.2, 1.2, 1.2],
        [1.2, 1.2, 1.2, ..., 1.2, 1.2, 1.2],
        [1.2, 1.2, 1.2, ..., 1.2, 1.2, 1.2],
        ...,
        [1.2, 1.2, 1.2, ..., 1.2, 1.2, 1.2],
        [1.2, 1.2, 1.2, ..., 1.2, 1.2, 1.2],
        [1.2, 1.2, 1.2, ..., 1.2, 1.2, 1.2]],

       [[0. , 0. , 0. , ..., 0. , 0. , 0. ],
        [0. , 0. , 0. , ..., 0. , 0. , 0. ],
        [0. , 0. , 0. , ..., 0. , 0. , 0. ],
        ...,
        [0. , 0. , 0. , ..., 0. , 0. , 0. ],
        [0. , 0. , 0. , ..., 0. , 0. , 0. ],
        [0. , 0. , 0. , ..., 0. , 0. , 0. ]],

       [[0. , 0. , 0. , ..., 0. , 0. , 0. ],
        [0. , 0. , 0. , ..., 0. , 0. , 0. ],
        [0. , 0. , 0. , ..., 0. , 0. , 0. ],
        ...,
        [0. , 0. , 0. , ..., 0. , 0. , 0. ],
        [0. , 0. , 0. , ..., 0. , 0. , 0. ],
        [0. , 0. , 0. , ..., 0. , 0. , 0. ]]])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[333]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ζfield = np.zeros(kfield.shape)</span>
<span class="c1"># ζfield[0] = kfield[1]</span>
<span class="c1"># ζfield[1] = -kfield[0]</span>
<span class="c1"># np.sqrt(np.sum(np.abs(ζfield)**2, axis=0))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[333]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[0., 0., 0., ..., 0., 0., 0.],
       [0., 0., 0., ..., 0., 0., 0.],
       [0., 0., 0., ..., 0., 0., 0.],
       ...,
       [0., 0., 0., ..., 0., 0., 0.],
       [0., 0., 0., ..., 0., 0., 0.],
       [0., 0., 0., ..., 0., 0., 0.]])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[329]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ζfield</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[329]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
750000
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[283]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">athing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">kref</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">bthing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">kref</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">cthing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">athing</span><span class="p">,</span> <span class="n">bthing</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">cthing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">athing</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">bthing</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">athing</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">bthing</span><span class="p">[</span><span class="mi">1</span><span class="p">]))),</span>
<span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">cthing</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="o">-</span><span class="n">athing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">bthing</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">athing</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">bthing</span><span class="p">[</span><span class="mi">0</span><span class="p">]))),</span>
<span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">cthing</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">athing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">bthing</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">athing</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">bthing</span><span class="p">[</span><span class="mi">0</span><span class="p">]))))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[283]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(0, 0, 0)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[274]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">Href</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="o">-</span><span class="n">kref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Eref</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">kref</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Eref</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[274]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
473
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[276]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">kref</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[276]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1418
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[258]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># indexpick = 80</span>
<span class="c1"># akinc = np.array([kfield[0,indexpick,indexpick], kfield[1,indexpick,indexpick], kfield[2,indexpick,indexpick]])</span>
<span class="c1"># aζinc = np.array([ζfield[0,indexpick,indexpick], ζfield[1,indexpick,indexpick], ζfield[2,indexpick,indexpick]])</span>
<span class="c1"># dot1 = np.dot(akinc, aζinc)</span>
<span class="c1"># akref = np.array([kref[0,indexpick,indexpick], kref[1,indexpick,indexpick], kref[2,indexpick,indexpick]])</span>
<span class="c1"># dot2 = np.dot(akref, aζinc)</span>
<span class="c1"># aθ = θfield[indexpick,indexpick]</span>
<span class="c1"># aβ = βfield[indexpick,indexpick]</span>
<span class="c1"># dot3 = np.dot(akinc, akref)</span>
<span class="c1"># (dot1, dot2, dot3 - np.cos(aθ-aβ))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[208]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># using these I can also compute the local field of tranmission</span>
<span class="n">transmissionS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">fresnelS</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">nFree</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">nCore</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">transmissionP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">fresnelP</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">nFree</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">nCore</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">iplot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">transmissionP</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">ember</span><span class="p">,</span>
                <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span>
<span class="n">circle</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">a</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">iplot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span><span class="c1">#, format=ticker.FuncFormatter(fmt))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_90_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_90_0.png" style="width: 908px; height: 814px;" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">transmissionS</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;frequency&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_92_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_92_0.png" style="width: 722px; height: 316px;" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">string</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;# Local-k approximation to refraction</span>

<span class="s1">Given a mode in the waveguide whose propagation is suddenly truncated by the end of the waveguide, find the fields right outside the fiber by using the direction of the Poynting vector as a local direction of propagation of the incident fields.</span>

<span class="s1">```</span>

<span class="s1">┌────────────────────────────────────────────────────────────────────────┐</span>
<span class="s1">│ ...................................................................... │</span>
<span class="s1">│ ...................................................................... │</span>
<span class="s1">│ ...............................┌──────┐............................... │</span>
<span class="s1">│ ...............................│E&#39;, H&#39;│............................... │</span>
<span class="s1">│ ...............................└──────┘....................      ..... │</span>
<span class="s1">│ ...........................................................  nr  ..... │</span>
<span class="s1">│ ...........................................................      ..... │</span>
<span class="s1">│ XXXXXXXXXXXXXXXXXXXXXXXXXXXX--------------XXXXXXXXXXXXXXXXXXXXXXXXXXXX │</span>
<span class="s1">│ XXXXXXXXXXXXXXXXXXXXXXXXXXXX--------------XXXXXXXXXXXXXXXX        XXXX │</span>
<span class="s1">│ XXXXXXXXXXXXXXXXXXXXXXXXXXXX----┌────┐----XXXXXXXXXXXXXXXX n(x,y) XXXX │</span>
<span class="s1">│ XXXXXXXXXXXXXXXXXXXXXXXXXXXX----│E, H│----XXXXXXXXXXXXXXXX        XXXX │</span>
<span class="s1">│ XXXXXXXXXXXXXXXXXXXXXXXXXXXX----└────┘----XXXXXXXXXXXXXXXXXXXXXXXXXXXX │</span>
<span class="s1">│ XXXXXXXXXXXXXXXXXXXXXXXXXXXX--------------XXXXXXXXXXXXXXXXXXXXXXXXXXXX │</span>
<span class="s1">│ XXXXXXXXXXXXXXXXXXXXXXXXXXXX--------------XXXXXXXXXXXXXXXXXXXXXXXXXXXX │</span>
<span class="s1">│ XXXXXXXXXXXXXXXXXXXXXXXXXXXX--------------XXXXXXXXXXXXXXXXXXXXXXXXXXXX │</span>
<span class="s1">│                                                                        │</span>
<span class="s1">│                                   │                                    │</span>
<span class="s1">│                                                                        │</span>
<span class="s1">│                                   │                                    │</span>
<span class="s1">│                                                                        │</span>
<span class="s1">│                                   ├┐                      ┌────        │</span>
<span class="s1">│                                    └─┐  θ            ┌────┘            │</span>
<span class="s1">│                                   │  └─┐        ┌────┘                 │</span>
<span class="s1">│                                        └─┐ ┌────┘                      │</span>
<span class="s1">│                                   │  ┌───┴─┘                  nr       │</span>
<span class="s1">│       ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┬────┘─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─      │</span>
<span class="s1">│                               ┌─┘ │                        n(x,y)      │</span>
<span class="s1">│                             ┌─┘                                        │</span>
<span class="s1">│                           ┌┬┘     │                                    │</span>
<span class="s1">│                         ┌─┘└─┐                                         │</span>
<span class="s1">│                       ┌─┘    └─┐  │                                    │</span>
<span class="s1">│                     ┌─┘     β  └─┐                                     │</span>
<span class="s1">│                   ┌─┘            └┤                                    │</span>
<span class="s1">│                 ┌─┘                                                    │</span>
<span class="s1">│                ─┘                 │                                    │</span>
<span class="s1">│                                                                        │</span>
<span class="s1">└────────────────────────────────────────────────────────────────────────┘</span>

<span class="s1">```</span>


<span class="s1">```mermaid</span>
<span class="s1">flowchart TB</span>

<span class="s1">Start[&quot;Given:</span>
<span class="s1">k_z : propagation constant of mode</span>
<span class="s1">Δλ  : sampling resolution of arrays</span>
<span class="s1">a   : the radius of the waveguide core</span>
<span class="s1">b   : side of computational square</span>
<span class="s1">nCore : ref index of core</span>
<span class="s1">nCladding : ref index of cladding</span>
<span class="s1">nFree : ref index of launching space&quot;]</span>

<span class="s1">Start --&gt; indexArray[&quot;[#nxy-Calc]</span>
<span class="s1">Calculate n(x,y) on a plane</span>
<span class="s1">transverse to the waveguide.&quot;]</span>

<span class="s1">Start --&gt; AeAhBeBh[&quot;[#AB-Calc]</span>
<span class="s1">Calculate the coefficients</span>
<span class="s1">Ae, Ah, Be, Bh over the core and cladding</span>
<span class="s1">regions for the related mode.&quot;]</span>

<span class="s1">AeAhBeBh --&gt; Field[&quot;[#EH-Calc]</span>
<span class="s1">Calculate the numerical</span>
<span class="s1">values of the mode over</span>
<span class="s1">a grid with resolution Δλ.</span>
<span class="s1">E(x,y) = (E_z, &lt;b&gt;E&lt;b/&gt;_T)</span>
<span class="s1">H(x,y) = (H_z, &lt;b&gt;H&lt;b/&gt;_T)&quot;]</span>

<span class="s1">Field --&gt;  Poynting[&quot;[#EXH-Calc]</span>
<span class="s1">Poynting Vector Field</span>
<span class="s1">&lt;b&gt;P&lt;/b&gt;(x,y) = ½ Re(&lt;b&gt;E&lt;/b&gt; x &lt;b&gt;H&lt;/b&gt;*)&quot;]</span>

<span class="s1">Poynting --&gt; localk[&quot;[#normIncidentk-Calc]</span>
<span class="s1">Normalized incident k &lt;br&gt;k̂ := &lt;b&gt;k&lt;/b&gt;/|k| ≈ &lt;b&gt;P&lt;/b&gt;/|P|&quot;]</span>

<span class="s1">localk --&gt; Incident[&quot;[#β-Calc]</span>
<span class="s1">Angle of incidence across interface</span>
<span class="s1">β(x,y)&quot;]</span>

<span class="s1">Incident &amp; indexArray --&gt;  Refracted[&quot;[#θ-Calc]</span>
<span class="s1">Angles of refraction across interface</span>
<span class="s1">θ(x,y)&quot;]</span>

<span class="s1">Incident &amp; Field --&gt; FresnelS[&quot;[#FresnelS-Calc]</span>
<span class="s1">Fresnel-S Coefficient</span>
<span class="s1">FS(x,y) = E_S&#39;/E_S (S-pol)&quot;]</span>

<span class="s1">Incident &amp; Field --&gt; FresnelP[&quot;[#FresnelP-Calc]</span>
<span class="s1">    Fresnel-P Coefficient&lt;br&gt;FP(x,y) = E_P&#39;/E_P (P-pol)&quot;]</span>

<span class="s1">localk --&gt; Sdir[&quot;[#ζ-Calc]</span>
<span class="s1">    S-Normal vector field</span>
<span class="s1">    (Direction normal to plane of incidence)</span>
<span class="s1">    &lt;b&gt;ζ(x,y)&lt;b/&gt; = ẑ x k̂</span>
<span class="s1">    ζ̂(x,y) = &lt;b&gt;ζ&lt;b/&gt; / |ζ|&quot;]</span>

<span class="s1">Sdir --&gt; Spol[&quot;[#EincS-Calc]</span>
<span class="s1">S-component of E</span>
<span class="s1">E_S = &lt;b&gt;E&lt;/b&gt; · ζ̂&quot;]</span>

<span class="s1">Spol --&gt; Ppol[&quot;[#EincP-Calc]</span>
<span class="s1">P-component of E</span>
<span class="s1">E_P = E - E_S&quot;]</span>

<span class="s1">Ppol &amp; FresnelP --&gt; EPref[&quot;[#ErefP-Calc]</span>
<span class="s1">Refracted E (P-pol)</span>
<span class="s1">E_P&#39; = E_P  FP(x,y)&quot;]</span>

<span class="s1">Spol &amp; FresnelS --&gt; ESref[&quot;[#ErefS-Calc]</span>
<span class="s1">Refracted E (S-pol)</span>
<span class="s1">E_S&#39; = E_S  FS(x,y)&quot;]</span>

<span class="s1">EPref &amp; ESref --&gt; Eref[&quot;[#Eref-Calc]</span>
<span class="s1">The refracted electric field</span>
<span class="s1">E&#39; = E_S + E_P&quot;]</span>

<span class="s1">indexArray &amp; localk --&gt; localkrefnorm[&quot;[#kref-Calc]</span>
<span class="s1">Normalized refracted k̂&#39;</span>
<span class="s1">&lt;b&gt;k̂&#39;&lt;/b&gt;&quot;]</span>

<span class="s1">localkrefnorm &amp; Eref --&gt; Href[&quot;[#Href-Calc]</span>
<span class="s1">The refracted H-field&lt;br&gt;H&#39; ≈ √(μ&#39;ϵ&#39;)/µ&#39; k̂&#39; x E&#39;&quot;]</span>

<span class="s1">style Start fill:blue</span>
<span class="s1">style Href fill:red</span>
<span class="s1">style Eref fill:red</span>
<span class="s1">```</span>
<span class="s1">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import re</span>

<span class="c1"># def extract_substrings_inside_square_brackets(text):</span>
<span class="c1">#     pattern = r&#39;\[#([^]]+)\]&#39;</span>
<span class="c1">#     substrings = re.findall(pattern, text)</span>
<span class="c1">#     return substrings</span>

<span class="c1"># hashes = extract_substrings_inside_square_brackets(string)</span>
<span class="c1"># for idx, hash in enumerate(hashes):</span>
<span class="c1">#     print(f&#39;{hash}&#39;)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">nxy-Calc</span>
<span class="sd">AB-Calc</span>
<span class="sd">EH-Calc</span>
<span class="sd">EXH-Calc</span>
<span class="sd">normIncidentk-Calc</span>
<span class="sd">β-Calc</span>
<span class="sd">θ-Calc</span>
<span class="sd">FresnelS-Calc</span>
<span class="sd">FresnelP-Calc</span>
<span class="sd">ζ-Calc</span>
<span class="sd">EincS-Calc</span>
<span class="sd">EincP-Calc</span>
<span class="sd">ErefP-Calc</span>
<span class="sd">ErefS-Calc</span>
<span class="sd">Eref-Calc</span>
<span class="sd">kref-Calc</span>
<span class="sd">Href-Calc</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
<section id="id1">
<h4>####Spaguetti code<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># given a field (Ex, Ey, Ez) at a plane calculate the discrete</span>
<span class="c1"># fourier transform of the field in the x,y,z directions</span>
<span class="c1"># this would provide the field in the frequency domain</span>
<span class="c1"># the field is assumed to be periodic in the x,y,z directions</span>
<span class="n">fiberfield_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">eigenbasis</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:,:])</span>
<span class="c1"># at the moment I haven&#39;t calculate the z component of the field</span>
<span class="c1"># let me just assume a z component that is roughly of the same magnitude</span>
<span class="c1"># of the x and y components, that starts normal at the center and</span>
<span class="c1"># deviates to the NA of the fiber at the edge of it</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Ex</span> <span class="o">=</span> <span class="n">fiberfield_t</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span>
<span class="n">Ey</span> <span class="o">=</span> <span class="n">fiberfield_t</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:]</span>
<span class="n">NA</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;NA&#39;</span><span class="p">]</span>
<span class="n">nCore</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;nCore&#39;</span><span class="p">]</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">fiber_sol</span><span class="p">[</span><span class="s1">&#39;coreRadius&#39;</span><span class="p">]</span>
<span class="n">thetamax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">NA</span><span class="o">/</span><span class="n">nCore</span><span class="p">)</span>
<span class="c1"># calculate the magnitude of the transverse field</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Xg</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Yg</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># calculate the angle of E at each point</span>
<span class="n">launchAngle</span> <span class="o">=</span> <span class="n">thetamax</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">r</span>
<span class="c1"># knowing the angle at each position I should be able to &quot;calculate&quot;</span>
<span class="c1"># the z component of the field</span>
<span class="c1"># this doesn&#39;t make any sense, the direction of the</span>
<span class="c1"># electric field is not the direction of the wave vector</span>
<span class="c1"># ok, instead let me estimate the direction of the wave vector</span>
<span class="c1"># across the fiber and then use that together with the field at</span>
<span class="c1"># each position to determine what is a compatible value for the z component</span>
<span class="n">kmag</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">λfree</span><span class="o">*</span><span class="n">nCore</span>
<span class="n">dirfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">Yg</span><span class="p">,</span> <span class="n">Xg</span><span class="p">)</span>
<span class="n">xhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dirfield</span><span class="p">)</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dirfield</span><span class="p">)</span>
<span class="n">kz</span> <span class="o">=</span> <span class="n">kmag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">launchAngle</span><span class="p">)</span>
<span class="n">kx</span> <span class="o">=</span> <span class="n">kmag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">launchAngle</span><span class="p">)</span> <span class="o">*</span> <span class="n">xhat</span>
<span class="n">ky</span> <span class="o">=</span> <span class="n">kmag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">launchAngle</span><span class="p">)</span> <span class="o">*</span> <span class="n">yhat</span>
<span class="c1"># at every point</span>
<span class="c1"># now let me make</span>
<span class="c1"># use this to calculate a possible z component for E</span>
<span class="n">dotEk</span> <span class="o">=</span> <span class="n">fiberfield_t</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">kx</span> <span class="o">+</span> <span class="n">fiberfield_t</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">ky</span>
<span class="n">Ez</span> <span class="o">=</span> <span class="o">-</span><span class="n">dotEk</span><span class="o">/</span><span class="n">kz</span>
<span class="c1"># in this construction the electric field is always in parallel to the plane of incidence</span>
<span class="n">fresnel</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nCore</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">launchAngle</span><span class="p">)</span>
           <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">launchAngle</span><span class="p">)</span> <span class="o">+</span> <span class="n">nCore</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nCore</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">launchAngle</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
<span class="n">Erefracted_x</span> <span class="o">=</span> <span class="n">fresnel</span> <span class="o">*</span> <span class="n">Ex</span>
<span class="n">Erefracted_y</span> <span class="o">=</span> <span class="n">fresnel</span> <span class="o">*</span> <span class="n">Ey</span>
<span class="n">Erefracted_z</span> <span class="o">=</span> <span class="n">fresnel</span> <span class="o">*</span> <span class="n">Ez</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Erefracted_x</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_99_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_99_0.png" style="width: 427px; height: 418px;" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ok, next part</span>
<span class="c1"># i need to find the farfield for the refracted field</span>
<span class="c1"># i think I have</span>
<span class="n">apertureRadius</span> <span class="o">=</span> <span class="n">b</span>
<span class="n">λ</span> <span class="o">=</span> <span class="n">λfree</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">λ</span>
<span class="n">replicas</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">dist_to_ML</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">zmax</span> <span class="o">=</span> <span class="n">dist_to_ML</span> <span class="o">*</span> <span class="mi">5</span>
<span class="n">farfield_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">zmax</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
<span class="n">L</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">apertureRadius</span> <span class="c1"># spatial extent of the field</span>
<span class="n">field</span> <span class="o">=</span> <span class="n">Erefracted_x</span>
<span class="n">dx</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">idx_width</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="n">replicas</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">nearfourier</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">field</span><span class="p">,(</span><span class="n">idx_width</span><span class="p">,</span> <span class="n">idx_width</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">field</span>
<span class="n">kx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="o">=</span><span class="n">dx</span><span class="p">))</span>
<span class="n">ky</span> <span class="o">=</span> <span class="n">kx</span>
<span class="n">kx</span><span class="p">,</span> <span class="n">ky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="p">)</span>
<span class="n">kz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">kx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">ky</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">0</span><span class="n">j</span><span class="p">)</span>

<span class="n">gator</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">farfield_axis</span><span class="p">,</span> <span class="n">kz</span><span class="p">)</span>
<span class="n">gator</span> <span class="o">=</span> <span class="n">gator</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">*</span><span class="n">farfield_axis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="o">*</span><span class="n">kz</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">gator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">gator</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cmasher</span> <span class="k">as</span> <span class="nn">cmr</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">farfields</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">fields</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ex&#39;</span><span class="p">:</span><span class="n">Erefracted_x</span><span class="p">,</span> <span class="s1">&#39;ey&#39;</span><span class="p">:</span><span class="n">Erefracted_y</span><span class="p">}</span>
<span class="k">for</span> <span class="n">field_component</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ex&#39;</span><span class="p">,</span><span class="s1">&#39;ey&#39;</span><span class="p">]:</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">field_component</span><span class="p">]</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">idx_width</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">field</span>
    <span class="c1"># calculate the Fourier transform of the nearfield</span>
    <span class="n">nearfourier</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <span class="c1"># multiply by the farfield propagator</span>
    <span class="n">farfourier</span> <span class="o">=</span> <span class="n">nearfourier</span> <span class="o">*</span> <span class="n">gator</span>
    <span class="c1"># calculate the inverse Fourier transform</span>
    <span class="n">farfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">farfourier</span><span class="p">)</span>

    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">L</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">replicas</span><span class="p">,</span> <span class="n">L</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">replicas</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">zmax</span><span class="p">]</span>
    <span class="c1"># get the field on the zx plane</span>
    <span class="n">pfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">farfield</span><span class="p">[::,</span><span class="n">farfield</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">farfields</span><span class="p">[</span><span class="n">field_component</span><span class="p">]</span> <span class="o">=</span> <span class="n">pfield</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pfield</span><span class="p">,</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmr</span><span class="o">.</span><span class="n">ember</span><span class="p">,</span>
            <span class="n">extent</span> <span class="o">=</span> <span class="n">extent</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="n">L</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">L</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x/$\mu$m&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;z/$\mu$m&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;|</span><span class="si">%s</span><span class="s1">|^2&#39;</span> <span class="o">%</span> <span class="n">field_component</span><span class="p">)</span>
<span class="c1">#     plt.colorbar()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_102_0.png" class="no-scaled-link" src="_images/wavesight-savepoint_102_0.png" style="width: 619px; height: 809px;" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/wavesight-savepoint_102_1.png" class="no-scaled-link" src="_images/wavesight-savepoint_102_1.png" style="width: 619px; height: 809px;" />
</div>
</div>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>